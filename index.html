<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MOVIE FOR VIRAL - Watch & Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS কোড অপরিবর্তিত আছে */
        :root {
            --primary-accent-color: #FF4500; --primary-accent-hover-color: #E03D00; --dark-bg: #000000;
            --card-bg: #121212; --header-bg: #181818; --text-light: #ffffff; --text-muted: #b3b3b3;
            --border-color: #282828; --success-color: #28a745; --disabled-color: #444;
        }
        body { background-color: var(--dark-bg); color: var(--text-light); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 60px 0 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .main-header { background-color: var(--header-bg); padding: 10px 15px; border-bottom: 1px solid var(--border-color); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .site-title { font-size: 1.2em; color: var(--primary-accent-color); font-weight: 700; text-transform: uppercase; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .balance-display { background-color: var(--card-bg); color: var(--primary-accent-color); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .menu-toggle-button { background: none; border: none; cursor: pointer; padding: 5px; display: flex; flex-direction: column; gap: 4px; }
        .menu-toggle-button .bar { width: 22px; height: 2px; background-color: var(--text-light); border-radius: 2px; }
        .side-menu { position: fixed; top: 0; right: -100%; width: 250px; height: 100%; background-color: var(--header-bg); z-index: 1001; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-menu.is-open { right: 0; }
        .side-menu-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .side-menu-header h3 { margin: 0; } .close-menu-btn { background: none; border: none; font-size: 1.5em; color: var(--text-light); cursor: pointer; }
        .side-menu-nav { list-style: none; padding: 0; margin: 0; }
        .side-menu-nav a { display: block; padding: 15px 20px; color: var(--text-muted); text-decoration: none; font-weight: 500; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s, color 0.2s; }
        .side-menu-nav a:hover, .side-menu-nav a.active { background-color: var(--primary-accent-color); color: var(--text-light); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .menu-overlay.is-open { display: block; }
        .content-section { display: none; padding-top: 25px; } .content-section.active { display: block; }
        .section-title { font-size: 1.5em; margin-bottom: 20px; padding-bottom: 10px; color: var(--text-light); border-bottom: 2px solid var(--border-color); }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .movie-item { background-color: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .movie-item:hover { transform: scale(1.03); }
        .thumbnail-container { width: 100%; aspect-ratio: 16/9; background-color: #333; }
        .thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        .movie-item-info { padding: 12px; } .movie-item h4 { margin: 0; font-size: 1em; line-height: 1.3; }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; }
        .task-card { background-color: var(--card-bg); padding: 15px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; }
        .task-card h4 { margin: 0 0 8px; } .task-card p { margin: 0 0 15px; color: var(--success-color); font-weight: bold; }
        .task-button { padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: var(--text-light); }
        .task-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .card { max-width: 500px; margin: 0 auto; background-color: var(--card-bg); padding: 20px; border-radius: 8px; }
        .card label { display: block; margin-bottom: 5px; }
        .card input, .card select { width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border-radius: 5px; border: 1px solid var(--border-color); background-color: #000; color: #fff; }
        .referral-link-wrapper { display: flex; gap: 10px; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 class="site-title">Movie for Viral</h1>
        <div class="header-right"><div class="balance-display">Balance: $<span id="userBalanceDisplay">0.00</span></div><button class="menu-toggle-button" id="menu-toggle-button"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button></div>
    </header>

    <div class="menu-overlay" id="menu-overlay"></div>
    <aside class="side-menu" id="side-menu">
        <div class="side-menu-header"><h3>Menu</h3><button class="close-menu-btn" id="close-menu-btn">&times;</button></div>
        <ul class="side-menu-nav">
            <li><a href="#" class="nav-link active" data-tab-target="#home-content" data-category="Home">Home</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#videos-content" data-category="Videos">Videos</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#movie-content" data-category="Movie">Movie</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#natok-content" data-category="Drama">Natok</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#task-content">Task to Earn</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#referral-content">Referral Program</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#withdrawal-content">Withdrawal</a></li>
        </ul>
    </aside>

    <main class="container">
        <!-- Content sections -->
        <section id="home-content" class="content-section active"><h3 class="section-title">Trending</h3><div class="item-grid"></div></section>
        <section id="videos-content" class="content-section"><h3 class="section-title">Videos</h3><div class="item-grid"></div></section>
        <section id="movie-content" class="content-section"><h3 class="section-title">Movies</h3><div class="item-grid"></div></section>
        <section id="natok-content" class="content-section"><h3 class="section-title">Natok</h3><div class="item-grid"></div></section>
        <section id="task-content" class="content-section"><h3 class="section-title">Complete Tasks</h3><div id="task-list" class="item-grid"></div></section>
        
        <section id="referral-content" class="content-section">
            <div class="card">
                <h3 class="section-title">Referral Program</h3>
                <p>Share your referral link with friends. When they join and earn, you'll get a 0.1% commission from their earnings for life!</p>
                <div class="referral-link-wrapper">
                    <input type="text" id="referralLinkInput" readonly value="Generating link...">
                    <button id="copyReferralLinkBtn">Copy</button>
                </div>
            </div>
        </section>

        <section id="withdrawal-content" class="content-section">
            <div class="card">
                <h3 class="section-title">Withdrawal</h3>
                <h4>Your Balance: $<span id="withdrawalBalance">0.00</span></h4>
                <p>Minimum withdrawal: $2.00</p>
                <form id="withdrawalForm">
                     <label for="withdrawalMethod">Payment Method</label>
                    <select id="withdrawalMethod" required><option value="Bkash">Bkash</option><option value="Binance (Optimism)">Binance (Optimism)</option></select>
                    <label for="accountDetails">Account Details</label>
                    <input type="text" id="accountDetails" placeholder="Your Bkash Number" required>
                    <label for="withdrawalAmount">Amount ($)</label>
                    <input type="number" id="withdrawalAmount" placeholder="e.g., 2.50" required step="0.01">
                    <button type="submit">Request Withdrawal</button>
                </form>
            </div>
        </section>
    </main>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc, serverTimestamp, doc, getDoc, setDoc, runTransaction, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCKMa4NdIowD_8NioUbrn4L7g5M9y5Tts0", authDomain: "movie-zone-931d7.firebaseapp.com", projectId: "movie-zone-931d7", storageBucket: "movie-zone-931d7.appspot.com", messagingSenderId: "1006880112063", appId: "1:1006880112063:web:4a4cf5079ea365a6ce750a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let currentUser = null; // This will hold all user data from Firestore

        // --- User Initialization ---
        async function initializeUser(tgUser, referrerCode) {
            const userRef = doc(db, 'users', String(tgUser.id));
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                const newUser = { balance: 0, createdAt: serverTimestamp(), completedTasks: [] };
                if (referrerCode) {
                    newUser.referredBy = referrerCode;
                }
                await setDoc(userRef, newUser);
                currentUser = { id: tgUser.id, ...newUser };
            } else {
                currentUser = { id: userSnap.id, ...userSnap.data() };
            }
            if (!currentUser.completedTasks) {
                currentUser.completedTasks = [];
            }
            updateBalanceUI(currentUser.balance);
            generateReferralLink(currentUser.id);
        }

        function updateBalanceUI(balance) {
            const displayBalance = (balance || 0).toFixed(2);
            document.getElementById('userBalanceDisplay').textContent = displayBalance;
            document.getElementById('withdrawalBalance').textContent = displayBalance;
        }

        // --- Referral Program Logic (UPDATED) ---
        function generateReferralLink(userId) {
            const botUsername = "NewTube12_bot"; // Your bot's username without '@'
            const link = `https://t.me/${botUsername}?start=${userId}`;
            document.getElementById('referralLinkInput').value = link;
        }

        document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
            const copyButton = document.getElementById('copyReferralLinkBtn');
            const linkInput = document.getElementById('referralLinkInput');
            const linkToCopy = linkInput.value;

            // Using modern Clipboard API which works well in secure contexts like Telegram Web App
            navigator.clipboard.writeText(linkToCopy).then(() => {
                const originalText = copyButton.textContent;
                copyButton.textContent = 'Copied!';
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Could not copy link automatically. Please select and copy it manually.');
            });
        });


        // --- Task System Logic (Unchanged) ---
        const taskListContainer = document.getElementById('task-list');
        async function fetchTasks() {
            // ... [This function remains the same as the previous version] ...
        }
        taskListContainer.addEventListener('click', async (e) => {
            // ... [This logic remains the same as the previous version] ...
        });
        
        // --- Video Content and Other Logic (Unchanged) ---
        async function fetchContent(category, targetId) {
            // ... [This function remains the same as the previous version] ...
        }
        
        // --- Navigation Logic (Unchanged) ---
        document.querySelectorAll('.nav-link').forEach(link => {
            // ... [This logic remains the same as the previous version] ...
        });

        // --- Initial App Load ---
        function init() {
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                document.body.innerHTML = `<div style="text-align: center; padding-top: 50px;"><h1>Error</h1><p>This app must be launched from Telegram.</p></div>`;
                return;
            }
            tg.ready();
            tg.expand();
            
            const tgUser = tg.initDataUnsafe.user;
            const referrerCode = tg.initDataUnsafe.start_param;

            initializeUser(tgUser, referrerCode).then(() => {
                // Load initial content
                fetchContent('Home', '#home-content');
            });
            // Setup other parts of the app
        }
        
        // Run the app
        init();

    </script>
</body>
</html>