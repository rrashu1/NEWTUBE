<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NEWTUBE - Watch & Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <!-- Monetag Ads Library -->
    <script src='//libtl.com/sdk.js' data-zone='9442539' data-sdk='show_9442539'></script>
    <!-- GigaPub Ads SDK -->
    <script src="https://ad.gigapub.tech/script?id=846"></script>
    <!-- Adexium Ads SDK (New) -->
    <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    <!-- RichInfo Ads SDK (New) -->
    <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">


    <style>
        :root {
            --primary-accent-color: #4A90E2; 
            --primary-accent-hover-color: #357ABD; 
            --dark-bg: #0e1621;
            --card-bg: #1c293a;
            --header-bg: #1c293a;
            --text-light: #ffffff;
            --text-muted: #a0b3d1;
            --border-color: #2a3b52;
            --success-color: #28a745;
            --disabled-color: #444;
            --pg-coin-color: #ff9900;
        }
        body { 
            background-color: var(--dark-bg); 
            color: var(--text-light); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 70px 0 90px; /* Adjusted padding for new header/footer */
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .main-header { 
            background-color: var(--header-bg); 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--border-color); 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 50px; 
        }
        .site-title { font-size: 1.4em; color: var(--primary-accent-color); font-weight: 700; margin: 0; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        
        /* Profile & Inbox Icons in Header */
        .header-icon-btn { position: relative; cursor: pointer; background: none; border: none; color: var(--text-light); padding: 5px; }
        .header-icon-btn svg { width: 26px; height: 26px; }
        #inbox-notification-dot { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background-color: var(--primary-accent-color); border-radius: 50%; border: 2px solid var(--header-bg); display: none; }
        #inbox-notification-dot.visible { display: block; }

        .balance-display { background-color: rgba(0,0,0,0.2); color: var(--text-light); padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9em; }
        .balance-display .pg-label { color: var(--pg-coin-color); }

        /* New Bottom Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }
        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; color: var(--text-muted); text-decoration: none;
            font-size: 0.75rem; font-weight: 500;
            padding: 5px 10px; border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .bottom-nav-item svg { width: 24px; height: 24px; }
        .bottom-nav-item:hover { color: var(--text-light); }
        .bottom-nav-item.active { color: var(--primary-accent-color); }

        .content-section { display: none; padding-top: 25px; } 
        .content-section.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title { font-size: 1.6em; margin-bottom: 25px; padding-bottom: 10px; color: var(--text-light); border-bottom: 2px solid var(--border-color); font-weight: 600; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-container input { flex-grow: 1; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-color); background-color: #000; color: var(--text-light); font-size: 1em; }
        .search-container button { padding: 12px 18px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: var(--text-light); font-weight: bold; cursor: pointer; }
        .search-container button#clearSearchBtn { background-color: #444; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        /* Card Styles */
        .movie-item, .ad-task-card, .task-card { background-color: var(--card-bg); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; }
        .movie-item { cursor: pointer; } 
        .movie-item:hover{ transform: scale(1.03); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .thumbnail-container { width: 100%; aspect-ratio: 16/9; background-color: #333; position: relative; }
        .thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; }
        .player-container iframe { width: 100%; height: 100%; border: none; }
        .movie-item-info, .ad-task-card-info { padding: 15px; flex-grow: 1; text-align:center;}
        .movie-item-info h4, .ad-task-card h4 { margin: 0 0 8px; font-size: 1.1em; line-height: 1.3; }
        .movie-reward { color: var(--pg-coin-color); font-weight: bold; font-size: 0.9em; margin: 0; }
        .ad-visits-left { color: var(--success-color); font-weight: bold; font-size: 0.9em; margin: 0; }
        
        .ad-task-card p { margin: 8px 0 15px; color: var(--text-muted); font-weight: bold; }
        .task-reward-pg { color: var(--pg-coin-color); }
        .ad-task-button { width: 100%; padding: 12px; border: none; border-radius: 0 0 10px 10px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: var(--text-light); transition: background-color .2s; margin-top: auto; font-size: 1em;}
        .task-button, .daily-task-button { width: auto; flex-shrink: 0; padding: 10px 20px; font-size: 0.9em; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: var(--text-light); transition: background-color .2s; margin-top: 0; }
        .task-button:disabled, .ad-task-button:disabled, .daily-task-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        
        .card { max-width: 500px; margin: 20px auto; background-color: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; }
        .card-icon { width: 50px; height: 50px; margin: 0 auto 15px; color: var(--primary-accent-color); }
        .card h3 { margin-top: 0; font-size: 1.4em; } .card p { color: var(--text-muted); line-height: 1.6; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-color); background-color: #000; color: var(--text-light); font-size: 1em; }
        .form-button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: var(--text-light); font-weight: bold; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        .form-button:hover:not(:disabled) { background-color: var(--primary-accent-hover-color); }
        .form-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        
        .referral-link-wrapper { display: flex; gap: 10px; margin-top: 20px; }
        .referral-link-wrapper input { flex-grow: 1; text-align: center; }
        .referral-link-wrapper button { width: auto; flex-shrink: 0; padding: 0 15px; }
        
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .history-item { background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-item .status-pending { color: #ffc107; } .history-item .status-approved { color: #28a745; } .history-item .status-rejected { color: #dc3545; }
        
        /* Modal Styles */
        .success-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .success-modal-overlay.show { display: flex; }
        .success-modal { background-color: var(--card-bg); color: var(--text-light); padding: 30px 40px; border-radius: 15px; text-align: center; transform: scale(0.9); opacity: 0; animation: modal-pop-in 0.3s forwards; }
        @keyframes modal-pop-in { to { transform: scale(1); opacity: 1; } }
        .success-modal-icon { width: 70px; height: 70px; border-radius: 50%; background-color: var(--success-color); display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold; color: white; margin: 0 auto 20px; animation: icon-pop-in 0.5s 0.2s backwards; }
        @keyframes icon-pop-in { 0% { transform: scale(0); } 70% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .success-modal h3 { margin: 0 0 10px; font-size: 1.6em; }
        .success-modal p { margin: 0; color: var(--text-muted); font-size: 1em; white-space: pre-wrap;}
        .inbox-modal { background-color: var(--card-bg); color: var(--text-light); padding: 20px; border-radius: 15px; text-align: left; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; }
        .inbox-modal h3 { text-align: center; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #inbox-message-list { overflow-y: auto; flex-grow: 1; margin-bottom: 15px; }
        .inbox-message-item { background-color: #2a3b52; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer;}
        .inbox-message-item p { margin: 0; line-height: 1.5; }
        .inbox-message-item.read { opacity: 0.6; }
        .inbox-message-item small { color: var(--text-muted); font-size: 0.8em; }
        #closeInboxBtn { padding: 10px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: white; cursor: pointer; }
        
        .sub-card { background-color: #0e1621; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .info-text { font-size: 0.9em; color: var(--text-muted); margin-top: 10px; line-height: 1.5; }
        
        /* Task & Ads Section Styles */
        .task-card, #daily-login-task-container .task-card { 
            background-color: var(--card-bg); border-radius: 8px; display: flex; flex-direction: row; justify-content: space-between; 
            align-items: center; padding: 15px; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
            border: none;
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15); }
        #ad-task-list.item-grid, #task-list.item-grid { grid-template-columns: 1fr; gap: 15px; } 
        .task-card-info { padding: 0; flex-grow: 1; text-align: left; }
        .task-card-info h4 { margin: 0 0 5px; }
        .task-card-info p { margin: 5px 0 0; }

        /* Profile Section Styles */
        #profile-card { background-color: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; }
        #profile-avatar { 
            width: 100px; height: 100px; border-radius: 50%; 
            border: 4px solid var(--primary-accent-color); 
            margin: 0 auto 20px; 
            display: flex; justify-content: center; align-items: center;
            background-color: #333; font-size: 48px; font-weight: bold; color: var(--text-light);
            background-size: cover; background-position: center;
        }
        #profile-username { font-size: 1.8em; font-weight: bold; margin: 0 0 5px; }
        #profile-userid { font-size: 1em; color: var(--text-muted); margin-bottom: 25px; cursor: pointer; }
        #profile-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .profile-stat-item { background-color: var(--dark-bg); padding: 20px; border-radius: 10px; }
        .profile-stat-item h4 { margin: 0 0 8px; font-size: 1em; color: var(--text-muted); font-weight: 500;}
        .profile-stat-item p { margin: 0; font-size: 1.5em; font-weight: bold; }
        .profile-stat-item .usdt-val { color: var(--success-color); }
        .profile-stat-item .pg-val { color: var(--pg-coin-color); }
        .profile-stat-item .ref-val { color: var(--primary-accent-color); }
        .profile-stat-item .game-val { color: #c874ff; }

        /* Home Section */
        #home-content .card { background: none; border: none; padding: 0; }
        #home-ads-container .ad-task-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 15px; }
        #home-ads-container .ad-task-button { width: auto; padding: 10px 20px; border-radius: 8px; margin-top: 0; }
        #home-ads-container .ad-task-card-info { text-align: left; }
        
        /* Withdraw Section */
        #withdraw-type-selector { display: flex; gap: 10px; margin-bottom: 25px; }
        #withdraw-type-selector button {
            flex: 1; padding: 12px; font-size: 1em; font-weight: 600;
            border: 2px solid var(--border-color);
            background-color: transparent;
            color: var(--text-muted);
            border-radius: 8px; cursor: pointer;
        }
        #withdraw-type-selector button.active {
            background-color: var(--primary-accent-color);
            border-color: var(--primary-accent-color);
            color: var(--text-light);
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 class="site-title">NEWTUBE</h1>
        <div class="header-right">
            <div class="balance-display">$: <span id="userUSDTBalanceDisplay">0.00</span></div>
            <div class="balance-display"><span class="pg-label">PG:</span> <span id="userPgCoinDisplay">0.000</span></div>
            <button class="header-icon-btn" id="inbox-container" title="Inbox">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
                <span id="inbox-notification-dot"></span>
            </button>
             <button class="header-icon-btn bottom-nav-item" data-tab-target="#profile-content" title="Profile">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </button>
        </div>
    </header>

    <main class="container">
        <!-- New Home Section -->
        <section id="home-content" class="content-section active">
            <h3 class="section-title">Welcome!</h3>
            <div class="card">
                <div class="sub-card">
                    <h4>Watch Ads, Earn Rewards</h4>
                    <div id="home-ads-container" class="item-grid" style="grid-template-columns: 1fr; gap: 10px;"></div>
                </div>
                <div class="sub-card" id="home-game-container">
                    <h4>New Game Coming Soon!</h4>
                    <p>Get ready for an exciting new game. Earn Game Tokens by referring friends and get a head start!</p>
                    <p class="info-text">Your Game Tokens: <strong id="home-game-tokens" style="color: #c874ff;">0</strong></p>
                </div>
            </div>
        </section>
        
        <section id="advertisement-content" class="content-section">
             <h3 class="section-title">Watch Ads, Earn Rewards</h3>
             <div id="ad-task-list" class="item-grid"></div>
        </section>

        <section id="video-content" class="content-section">
            <h3 class="section-title">Trending Videos</h3>
            <div class="search-container">
                <input type="search" id="videoSearchInput" placeholder="Search for videos...">
                <button id="videoSearchBtn">Search</button>
                <button id="clearSearchBtn" style="display:none;">Clear</button>
            </div>
            <div class="item-grid" id="video-grid"></div>
        </section>

        <section id="referral-content" class="content-section">
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                <h3>Referral Program</h3>
                <p>Invite friends and earn rewards! For each successful referral, you get <strong>0.4 PG Coin</strong> and <strong>1 Game Token!</strong></p>
                <div class="referral-link-wrapper"><input type="text" id="referralLinkInput" readonly value="Generating link..."><button id="copyReferralLinkBtn" class="form-button">Copy</button></div>
            </div>

            <h3 class="section-title" style="margin-top: 40px;">Your Referrals</h3>
             <div class="card" style="text-align: left; max-width: none;">
                <p style="text-align: center;">You have successfully referred the following users. The reward is added to your account instantly.</p>
                <div id="my-referrals-list"></div>
            </div>
        </section>

        <section id="task-content" class="content-section">
            <div id="daily-login-task-container"></div>
            <h3 class="section-title">Complete Tasks to Earn</h3>
            <div id="task-list" class="item-grid"></div>
        </section>
        
        <section id="withdraw-content" class="content-section">
             <div class="card" style="max-width: none;">
                 <h3 class="section-title" style="border: none; margin-bottom: 20px; text-align: center;">Withdraw</h3>
                 
                 <div id="withdraw-type-selector">
                     <button id="withdraw-type-usdt" class="active">Withdraw USDT</button>
                     <button id="withdraw-type-pg">Withdraw PG Coin</button>
                 </div>

                 <div id="usdt-withdraw-form">
                     <p>Your USDT Balance: <strong id="withdrawUsdtBalance">0.00</strong></p>
                     <form id="usdtWithdrawalForm">
                         <div class="form-group">
                            <label for="usdtWithdrawalMethod">Payment Method</label>
                            <select id="usdtWithdrawalMethod" required>
                                <option value="Bkash">Bkash (Min: $0.20, Fee: $0.02)</option>
                                <option value="Binance">Binance ID (Min: $0.50, Fee: $0.05)</option>
                            </select>
                         </div>
                         <div class="form-group">
                            <label for="usdtAccountDetails">Account Details</label>
                            <input type="text" id="usdtAccountDetails" placeholder="Your Bkash Number or Binance ID" required>
                         </div>
                         <div class="form-group">
                            <label for="usdtWithdrawalAmount">Amount (USDT)</label>
                            <input type="number" id="usdtWithdrawalAmount" placeholder="e.g., 1.0" required step="0.01">
                         </div>
                         <button type="submit" class="form-button">Request USDT Withdrawal</button>
                     </form>
                 </div>

                 <div id="pg-withdraw-form" style="display: none;">
                     <p>Your PG Coin Balance: <strong id="withdrawPgCoinBalance">0.000</strong></p>
                     <form id="pgWithdrawalForm">
                         <div class="form-group">
                            <label for="pgWithdrawalMethod">Payment Method</label>
                            <select id="pgWithdrawalMethod" required>
                                <option value="Bkash">Bkash (Min: 10 PG)</option>
                                <option value="Binance">Binance ID (Min: 25 PG)</option>
                            </select>
                         </div>
                         <div class="form-group">
                            <label for="pgAccountDetails">Account Details</label>
                            <input type="text" id="pgAccountDetails" placeholder="Your Bkash Number or Binance ID" required>
                         </div>
                         <div class="form-group">
                            <label for="pgWithdrawalAmount">Amount (PG Coin)</label>
                            <input type="number" id="pgWithdrawalAmount" placeholder="e.g., 10" required step="0.001">
                         </div>
                         <p class="info-text" style="text-align: center;">1 Dollar = 120 Taka (BDT)</p>
                         <button type="submit" class="form-button">Request PG Coin Withdrawal</button>
                     </form>
                 </div>
             </div>
             <h3 class="section-title" style="margin-top: 40px;">Withdrawal History</h3>
             <div id="history-list"></div>
        </section>

        <section id="profile-content" class="content-section">
            <h3 class="section-title">Your Profile</h3>
            <div id="profile-card">
                <div id="profile-avatar"></div>
                <h2 id="profile-username">Loading...</h2>
                <p id="profile-userid">ID: Loading...</p>
                
                <div id="profile-stats-grid">
                    <div class="profile-stat-item">
                        <h4>USDT Balance</h4>
                        <p id="profile-usdt" class="usdt-val">0.00</p>
                    </div>
                    <div class="profile-stat-item">
                        <h4>PG Coins</h4>
                        <p id="profile-pg-coins" class="pg-val">0.000</p>
                    </div>
                     <div class="profile-stat-item">
                        <h4>Lifetime Referrals</h4>
                        <p id="profile-referrals" class="ref-val">0</p>
                    </div>
                    <div class="profile-stat-item">
                        <h4>Game Tokens</h4>
                        <p id="profile-game-tokens" class="game-val">0</p>
                    </div>
                </div>
            </div>
        </section>
        
    </main>

    <!-- New Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active" data-tab-target="#home-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Home
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#advertisement-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM8 11H6V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg>
            Ads
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#video-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 16.5v-9l6 4.5-6 4.5zM20 4.44v15.12c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V4.44c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2z"/></svg>
            Video
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#referral-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            Referral
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#task-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 7h-9v-2h9v2zm0 4h-9v-2h9v2zm0 4h-9v-2h9v2zm-11-8H4v6h7V7zM3 5h9v14H3V5z"/></svg>
            Tasks
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#withdraw-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8H3V6h18v2zm0 6H3v-2h18v2zM5 18h14v-2H5v2zM3 20h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2z"/></svg>
            Withdraw
        </a>
    </nav>
    
    <div id="successModalOverlay" class="success-modal-overlay"><div class="success-modal"><div class="success-modal-icon">✓</div><h3 id="successModalTitle">Success!</h3><p id="successModalMessage">Your request has been sent.</p></div></div>
    
    <div id="inboxModalOverlay" class="success-modal-overlay">
        <div class="inbox-modal"><h3>Inbox</h3><div id="inbox-message-list"><div class="loader"></div></div><button id="closeInboxBtn" class="form-button" style="margin-top: 15px;">Close</button></div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api" async></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc, serverTimestamp, doc, getDoc, setDoc, updateDoc, runTransaction, increment, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCKMa4NdIowD_8NioUbrn4L7g5M9y5Tts0",
            authDomain: "movie-zone-931d7.firebaseapp.com",
            projectId: "movie-zone-931d7",
            storageBucket: "movie-zone-931d7.appspot.com",
            messagingSenderId: "1006880112063",
            appId: "1:1006880112063:web:4a4cf5079ea365a6ce750a",
            measurementId: "G-TH1YSE4D9C"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let currentUser = null;
        let player;
        let currentPlayingItem = null;
        let videoPlaybackInterval = null;
        let taskTimers = {};
        let isInterstitialAdVisible = false;

        const AD_POINTS_LIMIT = 10;
        const AD_PGCOIN_LIMIT = 10;
        const VIDEO_WATCH_LIMIT = 30; 
        const REFERRAL_BONUS_PG_COIN = 0.4;
        const REFERRAL_BONUS_GAME_TOKENS = 1;
        const DAILY_LOGIN_PG_REWARD = 0.02;

        async function fetchAndUpdateCurrentUser() {
            if (!currentUser?.id) return;
            try {
                const userRef = doc(db, 'users', currentUser.id);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    currentUser = { id: userSnap.id, ...userSnap.data() };
                    updateBalanceUI(currentUser.usdtBalance, currentUser.pgCoin);
                }
            } catch (error) { console.error("Error fetching current user:", error); }
        }
        
        async function checkAndResetDailies() {
            if (!currentUser) return;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const lastDailyReset = currentUser.lastDailyReset?.toDate();
            const lastDailyResetTime = lastDailyReset ? new Date(lastDailyReset.getFullYear(), lastDailyReset.getMonth(), lastDailyReset.getDate()).getTime() : 0;
            
            if (!lastDailyReset || lastDailyResetTime < today) {
                const updates = {
                    'lastDailyReset': serverTimestamp(),
                    'adVisitsToday': 0, 'pgCoinAdVisitsToday': 0, 'videoProgress.dailyWatchedCount': 0
                };
                try {
                    const userRef = doc(db, 'users', currentUser.id);
                    await updateDoc(userRef, updates);
                    await fetchAndUpdateCurrentUser(); 
                } catch (error) { console.error("Error resetting daily limits:", error); }
            }
        }

        async function grantReferralBonus(referrerId) {
            if (!referrerId) return;
            const referrerRef = doc(db, 'users', referrerId);
            try {
                await updateDoc(referrerRef, {
                    pgCoin: increment(REFERRAL_BONUS_PG_COIN),
                    gameTokens: increment(REFERRAL_BONUS_GAME_TOKENS),
                    referralCount: increment(1)
                });
            } catch (error) {
                console.error("Failed to grant referral bonus:", error);
            }
        }

        async function initializeUser(tgUser, referrerCode) {
            const userId = String(tgUser.id);
            const userRef = doc(db, 'users', userId);
            let userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                const defaultUserData = {
                    usdtBalance: 0, pgCoin: 0, lifetimePgCoinEarned: 0, 
                    referralCount: 0, gameTokens: 0,
                    completedTasks: [], adVisitsToday: 0, pgCoinAdVisitsToday: 0,
                    lastDailyReset: serverTimestamp(), lastDailyLoginClaim: null,
                    videoProgress: { dailyWatchedCount: 0 },
                    readMessages: [], withdrawalCount: 0,
                    createdAt: serverTimestamp(), 
                    telegramUsername: tgUser.username || 'N/A',
                };
                if (referrerCode && referrerCode !== userId) {
                    defaultUserData.referredBy = referrerCode;
                }
                await setDoc(userRef, defaultUserData);
                
                if (referrerCode && referrerCode !== userId) {
                    await grantReferralBonus(referrerCode);
                }
                userSnap = await getDoc(userRef);
            } else {
                // For existing users, ensure new fields exist
                const userData = userSnap.data();
                const updates = {};
                if (userData.gameTokens === undefined) updates.gameTokens = 0;
                if (userData.usdtBalance === undefined) updates.usdtBalance = 0;
                if (userData.pgCoin === undefined) updates.pgCoin = 0;
                // Add any other migrations for old users here

                if (Object.keys(updates).length > 0) {
                    await updateDoc(userRef, updates);
                    userSnap = await getDoc(userRef);
                }
            }
            
            currentUser = { id: userSnap.id, ...userSnap.data() };
            
            await checkAndResetDailies();
            updateBalanceUI(currentUser.usdtBalance, currentUser.pgCoin);
            generateReferralLink(currentUser.id);
            checkForUnreadMessages();
        }

        function updateBalanceUI(usdtBalance, pgCoinBalance) {
            const usdt = parseFloat(usdtBalance || 0).toFixed(2);
            const pgCoin = parseFloat(pgCoinBalance || 0).toFixed(3);
            document.getElementById('userUSDTBalanceDisplay').textContent = usdt;
            document.getElementById('userPgCoinDisplay').textContent = pgCoin;
        }

        function generateReferralLink(userId) {
            const botUsername = "NewTube12_bot";
            const webAppShortName = "newtubecash";
            const referralLink = `https://t.me/${botUsername}/${webAppShortName}?startapp=${userId}`;
            document.getElementById('referralLinkInput').value = referralLink;
        }
        
        document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
            const copyButton = document.getElementById('copyReferralLinkBtn');
            navigator.clipboard.writeText(copyButton.previousElementSibling.value).then(() => {
                copyButton.textContent = 'Copied!';
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
            });
        });

        async function grantReward(rewards) {
             if (!currentUser || !rewards.pgCoin) return;
             
             const userRef = doc(db, 'users', currentUser.id);
             await updateDoc(userRef, {
                 pgCoin: increment(rewards.pgCoin),
                 lifetimePgCoinEarned: increment(rewards.pgCoin)
             });
             await fetchAndUpdateCurrentUser();
        }
        
        async function renderVideos(snapshot) {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = ''; 
            if (snapshot.empty) {
                grid.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">No videos found.</p>';
                return;
            }
            snapshot.docs.forEach((docSnap) => {
                const video = docSnap.data();
                const item = document.createElement('article');
                item.className = 'movie-item';
                item.dataset.youtubeId = video.youtubeId;
                item.dataset.videoId = docSnap.id;
                
                item.originalContent = `
                    <div class="thumbnail-container">
                        <img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy">
                    </div>
                    <div class="movie-item-info">
                        <h4>${video.title}</h4>
                        <p class="movie-reward">Watch to Earn PG Coin</p>
                    </div>`;
                item.innerHTML = item.originalContent;
                item.addEventListener('click', handleVideoClick);
                grid.appendChild(item);
            });
        }

        async function fetchContent() {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '<div class="loader"></div>';
            try {
                const videosCollection = collection(db, 'videos');
                const q = query(videosCollection, orderBy('createdAt', 'desc'), limit(VIDEO_WATCH_LIMIT));
                const snapshot = await getDocs(q);
                await renderVideos(snapshot);
            } catch (error) { 
                console.error("Error fetching content:", error); 
                grid.innerHTML = '<p style="grid-column: 1 / -1;">Error loading content.</p>'; 
            }
        }
        
        async function handleVideoClick(event) {
            if (!currentUser) { alert("User data not loaded yet."); return; }

            const dailyWatchedCount = currentUser.videoProgress?.dailyWatchedCount || 0;
            if(dailyWatchedCount >= VIDEO_WATCH_LIMIT){
                alert(`You have reached your daily video watch limit of ${VIDEO_WATCH_LIMIT}.`);
                return;
            }

            if (currentPlayingItem) {
                clearInterval(videoPlaybackInterval);
                const originalContent = currentPlayingItem.originalContent;
                if(originalContent) currentPlayingItem.innerHTML = originalContent;
                if (player) { player.destroy(); player = null; }
            }
            const clickedItem = event.currentTarget;
            if (currentPlayingItem === clickedItem) {
                currentPlayingItem = null;
                return;
            }
            currentPlayingItem = clickedItem;
            const { youtubeId, videoId } = clickedItem.dataset;
            const playerDivId = `player-${youtubeId}-${Date.now()}`;
            
            clickedItem.innerHTML = `<div id="${playerDivId}" class="player-container"></div>`;
            
            player = new YT.Player(playerDivId, {
                height: '100%', width: '100%', videoId: youtubeId,
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'fs': 1 },
                events: {
                    'onStateChange': (e) => {
                         if (e.data === YT.PlayerState.PLAYING) {
                             if (!videoPlaybackInterval) {
                                videoPlaybackInterval = setInterval(async () => {
                                    const rewardPgCoin = parseFloat((Math.random() * (0.01 - 0.001) + 0.001).toFixed(4));
                                    await grantReward({ pgCoin: rewardPgCoin });
                                    showSuccessModal("Video Reward!", `You've earned ${rewardPgCoin} PG Coin for watching!`);
                                }, 2.5 * 60 * 1000);
                            }
                        } else {
                            clearInterval(videoPlaybackInterval);
                            videoPlaybackInterval = null;
                        }
                    }
                }
            });
        }
        
        function stopAndClearVideo() {
            clearInterval(videoPlaybackInterval);
            videoPlaybackInterval = null;
            if (currentPlayingItem) {
                const originalContent = currentPlayingItem.originalContent;
                if(originalContent) currentPlayingItem.innerHTML = originalContent;
            }
            if (player) { try { player.destroy(); } catch (e) {} player = null; }
            currentPlayingItem = null;
        }
        
        function setupAdsToEarn(containerId = 'ad-task-list') {
            const adTaskListContainer = document.getElementById(containerId);
            adTaskListContainer.innerHTML = '';
            if (!currentUser) return;
            
            const pgCoinVisitsToday = currentUser.pgCoinAdVisitsToday || 0;
            const pgCoinVisitsLeft = AD_PGCOIN_LIMIT - pgCoinVisitsToday;
            const isPgCoinLimitReached = pgCoinVisitsLeft <= 0;
            const pgCoinCard = document.createElement('div');
            pgCoinCard.className = 'ad-task-card';
            pgCoinCard.innerHTML = `
                <div class="ad-task-card-info">
                    <h4>Watch Ad & Earn PG Coin</h4>
                    <p>Reward: <span class="task-reward-pg">0.02 PG Coin</span></p>
                    <p class="ad-visits-left">Today's Visits Left: ${pgCoinVisitsLeft > 0 ? pgCoinVisitsLeft : 0} / ${AD_PGCOIN_LIMIT}</p>
                </div>
                <button class="ad-task-button" data-ad-type="pgcoin" ${isPgCoinLimitReached ? 'disabled' : ''}>
                    ${isPgCoinLimitReached ? 'Daily Limit Reached' : 'Watch Ad'}
                </button>`;
            adTaskListContainer.appendChild(pgCoinCard);

            adTaskListContainer.addEventListener('click', handleAdTaskClick);
        }
        
        async function handleAdTaskClick(e) {
            if (!e.target.matches('.ad-task-button') || e.target.disabled) return;
            const button = e.target;
            const adType = button.dataset.adType;
            
            button.disabled = true;
            button.textContent = 'Loading Ad...';
            
            try {
                await showRandomAdForTask();
                if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

                if (adType === 'pgcoin') {
                    await grantReward({ pgCoin: 0.02 });
                    await updateDoc(doc(db, 'users', currentUser.id), { pgCoinAdVisitsToday: increment(1) });
                    showSuccessModal("Congratulations!", "You've earned 0.02 PG Coin.");
                }
                
                await fetchAndUpdateCurrentUser();
                // Re-render the correct ad section
                const activeTab = document.querySelector('.content-section.active').id;
                if (activeTab === 'home-content') {
                    setupAdsToEarn('home-ads-container');
                } else {
                    setupAdsToEarn('ad-task-list');
                }

            } catch (err) {
                alert('You need to watch the complete ad to earn the reward.');
                const activeTab = document.querySelector('.content-section.active').id;
                if (activeTab === 'home-content') {
                    setupAdsToEarn('home-ads-container');
                } else {
                    setupAdsToEarn('ad-task-list');
                }
            }
        }
        
        async function renderDailyLoginTask() {
            const container = document.getElementById('daily-login-task-container');
            if (!container) return;
            container.innerHTML = '';
            if (!currentUser) return;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const lastClaim = currentUser.lastDailyLoginClaim?.toDate();
            const lastClaimTime = lastClaim ? new Date(lastClaim.getFullYear(), lastClaim.getMonth(), lastClaim.getDate()).getTime() : 0;
            const isClaimedToday = lastClaimTime >= today;

            const card = document.createElement('div');
            card.className = 'task-card';
            card.innerHTML = `
                <div class="task-card-info">
                    <h4>Daily Login Bonus</h4>
                    <p>Reward: <span class="task-reward-pg">${DAILY_LOGIN_PG_REWARD} PG</span></p>
                </div>
                <button class="task-button" id="dailyLoginClaimBtn" ${isClaimedToday ? 'disabled' : ''}>
                    ${isClaimedToday ? 'Claimed Today' : 'Claim'}
                </button>
            `;
            container.innerHTML = `<h3 class="section-title" style="font-size: 1.2em; border: none; margin-bottom: 15px;">Daily Reward</h3>`;
            container.appendChild(card);
            
            if (!isClaimedToday) {
                document.getElementById('dailyLoginClaimBtn').addEventListener('click', claimDailyLoginBonus);
            }
        }

        async function claimDailyLoginBonus() {
            const button = document.getElementById('dailyLoginClaimBtn');
            if (button) {
                button.disabled = true;
                button.textContent = '...';
            }
            try {
                await grantReward({ pgCoin: DAILY_LOGIN_PG_REWARD });
                await updateDoc(doc(db, 'users', currentUser.id), { lastDailyLoginClaim: serverTimestamp() });
                await fetchAndUpdateCurrentUser();
                showSuccessModal("Reward Claimed!", `You earned ${DAILY_LOGIN_PG_REWARD} PG for your daily login.`);
                renderDailyLoginTask(); 
            } catch (error) {
                alert('Failed to claim daily login bonus. Please try again.');
                if (button) button.disabled = false;
            }
        }

        async function fetchTasks() {
            const taskListContainer = document.getElementById('task-list');
            taskListContainer.innerHTML = '<div class="loader"></div>';
            try {
                const tasksRef = collection(db, 'tasks');
                const q = query(tasksRef, orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                taskListContainer.innerHTML = '';

                let hasTasks = false;
                snapshot.forEach(docSnap => {
                    const task = docSnap.data();
                    const rewardPg = task.rewardPg || 0;
                    if (task.isSpecial || rewardPg <= 0) return; // Only show tasks with PG rewards

                    hasTasks = true;
                    const taskId = docSnap.id;
                    const card = document.createElement('div');
                    card.className = 'task-card';
                    const isCompleted = currentUser.completedTasks?.includes(taskId);
                    const completionCount = task.completionCount || 0;
                    const taskLimit = task.limit || 0;
                    const isLimitReached = (taskLimit > 0) && (completionCount >= taskLimit);
                    
                    let buttonText = 'Go'; let buttonDisabled = false; let buttonState = 'start';
                    if (isCompleted) { buttonText = 'Done'; buttonDisabled = true; buttonState = 'done'; }
                    else if (isLimitReached) { buttonText = 'Limit Reached'; buttonDisabled = true; buttonState = 'limit_reached'; }

                    card.innerHTML = `
                        <div class="task-card-info">
                            <h4>${task.title}</h4>
                            <p>Reward: <span class="task-reward-pg">${rewardPg} PG</span></p>
                        </div>
                        <button class="task-button" data-task-id="${taskId}" data-task-url="${task.url}" data-reward-pg="${rewardPg}" data-visit-duration="${task.visitDurationSeconds || 0}" data-state="${buttonState}" ${buttonDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>`;
                    taskListContainer.appendChild(card);
                });
                
                if (!hasTasks) {
                    taskListContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">No tasks available right now.</p>';
                }

            } catch (error) {
                console.error("Error fetching tasks:", error);
                taskListContainer.innerHTML = '<p style="color:red; text-align:center; grid-column: 1 / -1;">Could not load tasks.</p>';
            }
        }
        
        document.getElementById('task-list').addEventListener('click', handleTaskClick);

        async function handleTaskClick(e) {
            if (!e.target.matches('.task-button') || e.target.disabled) return;
            const button = e.target;
            const { taskId, taskUrl, state } = button.dataset;
            const rewardPg = Number(button.dataset.rewardPg) || 0;
            const visitDuration = parseInt(button.dataset.visitDuration, 10) || 0;

            if (state === 'start') {
                if (!taskUrl) { alert('Task URL is missing.'); return; }
                if (visitDuration > 0) {
                    taskTimers[taskId] = Date.now();
                    button.textContent = `Claim after ${visitDuration}s`;
                    button.dataset.state = 'claim';
                } else {
                    button.textContent = 'Claim Reward';
                    button.dataset.state = 'claim';
                }
                tg.openLink(taskUrl);
            } else if (state === 'claim') {
                if (visitDuration > 0) {
                    const startTime = taskTimers[taskId];
                    if (!startTime || (Date.now() - startTime) / 1000 < visitDuration) {
                        alert(`You must visit the site for at least ${visitDuration} seconds. Please try again.`);
                        delete taskTimers[taskId];
                        button.textContent = 'Go'; button.dataset.state = 'start';
                        return;
                    }
                }
                button.disabled = true; button.textContent = 'Verifying...';
                try {
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, 'users', currentUser.id);
                        const taskRef = doc(db, 'tasks', taskId);
                        const userDoc = await transaction.get(userRef);
                        const taskDoc = await transaction.get(taskRef);
                        if (!userDoc.exists() || !taskDoc.exists()) throw "USER_OR_TASK_NOT_FOUND";
                        if (userDoc.data().completedTasks?.includes(taskId)) throw "ALREADY_COMPLETED";
                        const taskData = taskDoc.data();
                        if ((taskData.limit || 0) > 0 && (taskData.completionCount || 0) >= taskData.limit) throw "TASK_LIMIT_REACHED";
                        transaction.update(userRef, { completedTasks: arrayUnion(taskId) });
                        transaction.update(taskRef, { completionCount: increment(1) });
                    });
                    delete taskTimers[taskId];
                    await grantReward({ pgCoin: rewardPg });
                    showSuccessModal("Reward Claimed!", `Reward added to your balance.`);
                    button.textContent = 'Done';
                } catch (error) {
                    const errorMessages = { "ALREADY_COMPLETED": "You have already completed this task.", "TASK_LIMIT_REACHED": "This task has reached its completion limit."};
                    alert(errorMessages[error] || 'Failed to claim reward.');
                    button.disabled = (error === "ALREADY_COMPLETED" || error === "TASK_LIMIT_REACHED");
                    button.textContent = button.disabled ? 'Done' : 'Claim Reward';
                }
            }
        }

        function showSuccessModal(title, message) {
            const modal = document.getElementById('successModalOverlay');
            document.getElementById('successModalTitle').textContent = title;
            document.getElementById('successModalMessage').textContent = message;
            modal.classList.add('show');
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => { modal.classList.remove('show'); }, 4000);
        }
        
        async function renderWithdrawUI() {
            if (!currentUser) return;
            document.getElementById('withdrawUsdtBalance').textContent = (currentUser.usdtBalance || 0).toFixed(2);
            document.getElementById('withdrawPgCoinBalance').textContent = (currentUser.pgCoin || 0).toFixed(3);
        }

        document.getElementById('usdtWithdrawalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleWithdrawal('usdt', e.target);
        });

        document.getElementById('pgWithdrawalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleWithdrawal('pg', e.target);
        });

        async function handleWithdrawal(type, form) {
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            const method = form.querySelector('select').value;
            const details = form.querySelector('input[type="text"]').value;
            const amount = parseFloat(form.querySelector('input[type="number"]').value);

            let minAmount, balanceField, amountField, fee;
            
            try {
                if (type === 'usdt') {
                    balanceField = 'usdtBalance';
                    amountField = 'usdAmount';
                    if (method === 'Bkash') { minAmount = 0.20; fee = 0.02; }
                    else { minAmount = 0.50; fee = 0.05; }
                } else { // pg
                    balanceField = 'pgCoin';
                    amountField = 'pgAmount';
                    if (method === 'Bkash') { minAmount = 10; }
                    else { minAmount = 25; }
                    fee = 0; // Fees are for USDT withdrawals
                }

                if (isNaN(amount) || amount < minAmount) throw new Error(`Minimum withdrawal is ${minAmount} ${type === 'usdt' ? 'USDT' : 'PG'}.`);
                if (amount > (currentUser[balanceField] || 0)) throw new Error(`Insufficient ${type === 'usdt' ? 'USDT' : 'PG Coin'} balance.`);

                const requestData = {
                    userId: currentUser.id,
                    telegramUsername: currentUser.telegramUsername,
                    method: method,
                    details: details,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    withdrawType: type
                };
                requestData[amountField] = amount;

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, 'users', currentUser.id);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw new Error("User not found.");
                    const currentBalance = userDoc.data()[balanceField] || 0;
                    if (currentBalance < amount) throw new Error(`Insufficient balance.`);
                    
                    transaction.set(doc(collection(db, 'withdrawals')), requestData);
                    transaction.update(userRef, {
                        [balanceField]: increment(-amount),
                        withdrawalCount: increment(1)
                    });
                });
                
                await fetchAndUpdateCurrentUser();
                form.reset();
                showSuccessModal("Request Sent!", "Your withdrawal request is pending. Check status in the History tab below.");

            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = `Request ${type.toUpperCase()} Withdrawal`;
                renderWithdrawUI();
            }
        }

        async function displayWithdrawalHistory() {
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = '<div class="loader"></div>';
            try {
                const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"), limit(50));
                const snapshot = await getDocs(q);
                historyContainer.innerHTML = '';
                if (snapshot.empty) { historyContainer.innerHTML = '<p style="text-align:center;">No withdrawal history found.</p>'; return; }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const date = data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                    const status = data.status || 'pending';
                    const amountText = data.withdrawType === 'pg' ? `${parseFloat(data.pgAmount || 0).toFixed(3)} PG` : `$${parseFloat(data.usdAmount || 0).toFixed(2)} USDT`;
                    
                    item.innerHTML = `<div><strong>${amountText}</strong><br><small>${data.method} - ${date}</small></div><strong class="status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</strong>`;
                    historyContainer.appendChild(item);
                });
            } catch (error) { console.error("Error fetching history:", error); historyContainer.innerHTML = '<p style="color:red;">Error loading history.</p>'; }
        }
        
        async function fetchMyReferrals() {
            const myReferralsContainer = document.getElementById('my-referrals-list');
            myReferralsContainer.innerHTML = '<div class="loader"></div>';
            try {
                const q = query(collection(db, "users"), where("referredBy", "==", currentUser.id), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                myReferralsContainer.innerHTML = '';
                if (snapshot.empty) { 
                    myReferralsContainer.innerHTML = '<p style="text-align:center;">You haven\'t referred anyone yet.</p>'; 
                } else { 
                    snapshot.forEach(docSnap => {
                        const referee = docSnap.data();
                        const item = document.createElement('div');
                        item.className = 'history-item'; // Re-using style
                        item.innerHTML = `
                            <div><strong>${referee.telegramUsername || 'User...'}</strong></div>
                            <div class="count" style="color: var(--success-color);">Reward Granted</div>
                        `;
                        myReferralsContainer.appendChild(item);
                    });
                }
            } catch(error) { 
                myReferralsContainer.innerHTML = '<p style="color:red; text-align:center;">Could not load your referrals.</p>'; 
            }
        }

        function renderProfile() {
            if (!currentUser) return;
            
            document.getElementById('profile-username').textContent = currentUser.telegramUsername || 'User';
            document.getElementById('profile-userid').textContent = `ID: ${currentUser.id}`;
            document.getElementById('profile-usdt').textContent = (currentUser.usdtBalance || 0).toFixed(2);
            document.getElementById('profile-pg-coins').textContent = (currentUser.pgCoin || 0).toFixed(3);
            document.getElementById('profile-referrals').textContent = currentUser.referralCount || 0;
            document.getElementById('profile-game-tokens').textContent = currentUser.gameTokens || 0;
            
            const avatarEl = document.getElementById('profile-avatar');
            const username = currentUser.telegramUsername || 'User';
            const initial = username.charAt(0).toUpperCase();
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 50%, 40%)`;
            avatarEl.style.backgroundColor = color;
            avatarEl.style.backgroundImage = 'none';
            avatarEl.textContent = initial;
        }
        
        const showMonetagAd = () => new Promise((res, rej) => typeof show_9442539 === 'function' ? show_9442539().then(res).catch(rej) : rej('Monetag SDK missing'));
        const showGigaPubAd = () => new Promise((res, rej) => typeof window.showGiga === 'function' ? window.showGiga("main").then(res).catch(rej) : rej('GigaPub SDK missing'));
        async function showRandomAdForTask() {
            isInterstitialAdVisible = true;
            const adNetworks = [showMonetagAd, showGigaPubAd];
            try {
                await adNetworks[Math.floor(Math.random() * adNetworks.length)]();
            } finally {
                isInterstitialAdVisible = false;
            }
        }
        
        async function checkForUnreadMessages() {
            if (!currentUser) return;
            const messagesRef = collection(db, 'messages');
            const q = query(messagesRef, orderBy('createdAt', 'desc'), limit(20));
            const snapshot = await getDocs(q);
            const readMessages = currentUser.readMessages || [];
            const unread = snapshot.docs.some(doc => !readMessages.includes(doc.id));
            const dot = document.getElementById('inbox-notification-dot');
            if (unread) dot.classList.add('visible');
            else dot.classList.remove('visible');
        }

        async function openInbox() {
            const listContainer = document.getElementById('inbox-message-list');
            const modal = document.getElementById('inboxModalOverlay');
            modal.classList.add('show');
            listContainer.innerHTML = '<div class="loader"></div>';

            const messagesRef = collection(db, 'messages');
            const q = query(messagesRef, orderBy('createdAt', 'desc'), limit(20));
            const snapshot = await getDocs(q);
            listContainer.innerHTML = '';
            
            if (snapshot.empty) {
                listContainer.innerHTML = '<p style="text-align:center;">Your inbox is empty.</p>';
                return;
            }
            
            const readMessages = currentUser.readMessages || [];
            const messagesToMarkAsRead = [];

            snapshot.forEach(docSnap => {
                const message = docSnap.data();
                const item = document.createElement('div');
                item.className = 'inbox-message-item';
                if(readMessages.includes(docSnap.id)) item.classList.add('read');

                item.innerHTML = `
                    <p>${message.text}</p>
                    <small>${message.createdAt.toDate().toLocaleString()}</small>
                `;
                listContainer.appendChild(item);
                if (!readMessages.includes(docSnap.id)) {
                    messagesToMarkAsRead.push(docSnap.id);
                }
            });

            if (messagesToMarkAsRead.length > 0) {
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    readMessages: arrayUnion(...messagesToMarkAsRead)
                });
                await fetchAndUpdateCurrentUser();
                checkForUnreadMessages();
            }
        }

        document.getElementById('inbox-container').addEventListener('click', openInbox);
        document.getElementById('closeInboxBtn').addEventListener('click', () => {
             document.getElementById('inboxModalOverlay').classList.remove('show');
        });

        document.querySelectorAll('.bottom-nav-item').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                if (!currentUser || link.classList.contains('active')) return;
                
                stopAndClearVideo();
                document.querySelectorAll('.bottom-nav-item, .content-section').forEach(el => el.classList.remove('active'));
                
                // Activate clicked nav item and corresponding content
                link.classList.add('active');
                const targetId = link.dataset.tabTarget;
                const targetContent = document.querySelector(targetId);
                if(targetContent) targetContent.classList.add('active');

                // Activate corresponding header icon if it exists
                const headerIcon = document.querySelector(`.header-icon-btn[data-tab-target="${targetId}"]`);
                if(headerIcon) headerIcon.classList.add('active');

                // Run section-specific setup functions
                switch(targetId) {
                    case '#home-content': 
                        setupAdsToEarn('home-ads-container');
                        document.getElementById('home-game-tokens').textContent = currentUser.gameTokens || 0;
                        break;
                    case '#advertisement-content': setupAdsToEarn('ad-task-list'); break;
                    case '#video-content': /* Already fetched */ break;
                    case '#profile-content': renderProfile(); break;
                    case '#task-content': await renderDailyLoginTask(); await fetchTasks(); break;
                    case '#referral-content': await fetchMyReferrals(); break;
                    case '#withdraw-content': await renderWithdrawUI(); await displayWithdrawalHistory(); break;
                }
            });
        });

        function manageAdTimers() {
            try {
                const adexiumWidget = new AdexiumWidget({ wid: '12c05dba-2642-46f2-950f-cee6575119c9', adFormat: 'interstitial' });
                
                setInterval(() => {
                    if (isInterstitialAdVisible) { return; }
                    
                    isInterstitialAdVisible = true;
                    adexiumWidget.show()
                        .catch(err => console.error("Timed Adexium ad failed to show:", err))
                        .finally(() => { isInterstitialAdVisible = false; });
                }, 3 * 60 * 1000); 
            } catch (e) {
                console.error("Failed to initialize Adexium for timed display:", e);
            }
        }

        function setupWithdrawalTypeSwitcher() {
            const usdtBtn = document.getElementById('withdraw-type-usdt');
            const pgBtn = document.getElementById('withdraw-type-pg');
            const usdtForm = document.getElementById('usdt-withdraw-form');
            const pgForm = document.getElementById('pg-withdraw-form');

            usdtBtn.addEventListener('click', () => {
                usdtBtn.classList.add('active');
                pgBtn.classList.remove('active');
                usdtForm.style.display = 'block';
                pgForm.style.display = 'none';
            });
            pgBtn.addEventListener('click', () => {
                pgBtn.classList.add('active');
                usdtBtn.classList.remove('active');
                pgForm.style.display = 'block';
                usdtForm.style.display = 'none';
            });
        }

        async function main() {
            try {
                if (!tg.initDataUnsafe?.user) {
                    document.body.innerHTML = `<div class="card" style="margin-top: 50px;"><h3>Error</h3><p>This app can only be launched from Telegram.</p></div>`; return;
                }
                tg.ready(); tg.expand();
                
                await initializeUser(tg.initDataUnsafe.user, tg.initDataUnsafe.start_param);
                await fetchContent(); 
                setupAdsToEarn('home-ads-container');
                document.getElementById('home-game-tokens').textContent = currentUser.gameTokens || 0;

                manageAdTimers();
                setupWithdrawalTypeSwitcher();

                document.getElementById('profile-userid').addEventListener('click', () => {
                    if (currentUser && currentUser.id) navigator.clipboard.writeText(currentUser.id).then(() => {
                        if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                        showSuccessModal("Copied!", `User ID ${currentUser.id} copied to clipboard.`);
                    });
                });

            } catch (error) {
                console.error("Initialization failed:", error);
                document.body.innerHTML = `<div class="card" style="margin-top: 50px;"><h3>Application Error</h3><p>Could not initialize. Please restart.</p><p style="font-size: 0.8em; color: #888;">Error: ${error.message}</p></div>`;
            }
        }
        main();
    </script>

</body>
</html>