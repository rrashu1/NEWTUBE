<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MOVIE FOR VIRAL - Watch & Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Telegram Ads Library -->
    <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    <style>
        :root {
            --primary-accent-color: #FF4500; --primary-accent-hover-color: #E03D00; --dark-bg: #000000;
            --card-bg: #1a1a1a; --header-bg: #181818; --text-light: #ffffff; --text-muted: #b3b3b3;
            --border-color: #282828; --success-color: #28a745; --disabled-color: #444;
        }
        body { background-color: var(--dark-bg); color: var(--text-light); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 60px 0 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .main-header { background-color: var(--header-bg); padding: 10px 15px; border-bottom: 1px solid var(--border-color); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .site-title { font-size: 1.2em; color: var(--primary-accent-color); font-weight: 700; text-transform: uppercase; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .balance-display { background-color: #2a2a2a; color: var(--primary-accent-color); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .menu-toggle-button { background: none; border: none; cursor: pointer; padding: 5px; display: flex; flex-direction: column; gap: 4px; }
        .menu-toggle-button .bar { width: 22px; height: 2px; background-color: var(--text-light); border-radius: 2px; }
        .side-menu { position: fixed; top: 0; right: -100%; width: 250px; height: 100%; background-color: var(--header-bg); z-index: 1001; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-menu.is-open { right: 0; }
        .side-menu-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .side-menu-header h3 { margin: 0; } .close-menu-btn { background: none; border: none; font-size: 1.5em; color: var(--text-light); cursor: pointer; }
        .side-menu-nav { list-style: none; padding: 0; margin: 0; }
        .side-menu-nav a { display: block; padding: 15px 20px; color: var(--text-muted); text-decoration: none; font-weight: 500; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s, color 0.2s; }
        .side-menu-nav a:hover, .side-menu-nav a.active { background-color: var(--primary-accent-color); color: var(--text-light); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .menu-overlay.is-open { display: block; }
        .content-section { display: none; padding-top: 25px; } .content-section.active { display: block; }
        .section-title { font-size: 1.5em; margin-bottom: 20px; padding-bottom: 10px; color: var(--text-light); border-bottom: 2px solid var(--border-color); }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .movie-item, .task-card, .ad-task-card { background-color: var(--card-bg); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .movie-item { cursor: pointer; transition: transform 0.2s; } .movie-item:hover{ transform: scale(1.03); }
        .thumbnail-container { width: 100%; aspect-ratio: 16/9; background-color: #333; }
        .thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        .movie-item-info, .task-card-info, .ad-task-card-info { padding: 15px; flex-grow: 1; text-align:center;}
        .movie-item-info h4, .task-card h4, .ad-task-card h4 { margin: 0; font-size: 1.1em; line-height: 1.3; }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; }
        .task-card p, .ad-task-card p { margin: 8px 0 15px; color: var(--success-color); font-weight: bold; }
        .task-button, .ad-task-button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: var(--text-light); transition: background-color .2s; margin-top: auto; font-size: 1em;}
        .task-button:disabled, .ad-task-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .card { max-width: 500px; margin: 20px auto; background-color: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; }
        .card-icon { width: 50px; height: 50px; margin: 0 auto 15px; color: var(--primary-accent-color); }
        .card h3 { margin-top: 0; font-size: 1.4em; } .card p { color: var(--text-muted); line-height: 1.6; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-color); background-color: #000; color: var(--text-light); font-size: 1em; }
        .form-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: var(--text-light); font-weight: bold; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        .form-button:hover { background-color: var(--primary-accent-hover-color); }
        .referral-link-wrapper { display: flex; gap: 10px; margin-top: 20px; }
        .referral-link-wrapper input { flex-grow: 1; text-align: center; }
        .referral-link-wrapper button { width: auto; flex-shrink: 0; padding: 0 15px; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        .history-item { background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-item .status-pending { color: #ffc107; } .history-item .status-approved { color: #28a745; } .history-item .status-rejected { color: #dc3545; }
        .conversion-info { font-size: 0.9em; color: var(--text-muted); margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 class="site-title">Movie for Viral</h1>
        <div class="header-right"><div class="balance-display">Points: <span id="userBalanceDisplay">0</span></div><button class="menu-toggle-button" id="menu-toggle-button"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button></div>
    </header>

    <div class="menu-overlay" id="menu-overlay"></div>
    <aside class="side-menu" id="side-menu">
        <div class="side-menu-header"><h3>Menu</h3><button class="close-menu-btn" id="close-menu-btn">&times;</button></div>
        <ul class="side-menu-nav">
            <li><a href="#" class="nav-link active" data-tab-target="#home-content" data-category="Home">Home</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#videos-content" data-category="Videos">Videos</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#ads-to-earn-content">Ads to Earn</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#task-content">Task to Earn</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#referral-content">Referral Program</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#withdrawal-content">Withdrawal</a></li>
            <li><a href="#" class="nav-link" data-tab-target="#history-content">History</a></li>
        </ul>
    </aside>

    <main class="container">
        <!-- Content sections -->
        <section id="home-content" class="content-section active"><h3 class="section-title">Trending</h3><div class="item-grid"></div></section>
        <section id="videos-content" class="content-section"><h3 class="section-title">Videos</h3><div class="item-grid"></div></section>
        
        <section id="ads-to-earn-content" class="content-section">
            <h3 class="section-title">Watch Ads, Earn Points</h3>
            <div id="ad-task-list" class="item-grid">
                <!-- Ad tasks will be generated here by JS -->
            </div>
        </section>

        <section id="task-content" class="content-section"><h3 class="section-title">Complete Tasks</h3><div id="task-list" class="item-grid"></div></section>
        
        <section id="referral-content" class="content-section">
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                <h3>Referral Program</h3>
                <p>Invite friends with your unique link. You'll earn a 0.1% commission from their earnings, for life!</p>
                <div class="referral-link-wrapper">
                    <input type="text" id="referralLinkInput" readonly value="Generating link...">
                    <button id="copyReferralLinkBtn" class="form-button">Copy</button>
                </div>
            </div>
        </section>

        <section id="withdrawal-content" class="content-section">
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                <h3>Withdrawal</h3>
                <p>Your current balance: <strong><span id="withdrawalBalance">0</span> Points</strong></p>
                <div class="conversion-info">Conversion: 1000 Points = $0.02 USD<br>Minimum withdrawal: 100,000 Points ($2.00)</div>
                <form id="withdrawalForm" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="withdrawalMethod">Payment Method</label>
                        <select id="withdrawalMethod" required><option value="Bkash">Bkash</option><option value="Binance (Optimism)">Binance (Optimism)</option></select>
                    </div>
                    <div class="form-group">
                        <label for="accountDetails">Account Details</label>
                        <input type="text" id="accountDetails" placeholder="Your Bkash Number" required>
                    </div>
                    <div class="form-group">
                        <label for="withdrawalAmount">Amount (Points)</label>
                        <input type="number" id="withdrawalAmount" placeholder="e.g., 100000" required step="1" min="100000">
                    </div>
                    <button type="submit" class="form-button">Request Withdrawal</button>
                </form>
            </div>
        </section>

        <section id="history-content" class="content-section">
            <h3 class="section-title">Withdrawal History</h3>
            <div id="history-list">
                <div class="loader"></div>
            </div>
        </section>

    </main>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc, serverTimestamp, doc, getDoc, setDoc, runTransaction, increment, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCKMa4NdIowD_8NioUbrn4L7g5M9y5Tts0",
            authDomain: "movie-zone-931d7.firebaseapp.com",
            projectId: "movie-zone-931d7",
            storageBucket: "movie-zone-931d7.appspot.com",
            messagingSenderId: "1006880112063",
            appId: "1:1006880112063:web:4a4cf5079ea365a6ce750a",
            measurementId: "G-TH1YSE4D9C"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let currentUser = null;
        let player;
        let currentPlayingItem = null;
        let adexiumWidget; // Make ad widget globally accessible

        // --- User Initialization ---
        async function initializeUser(tgUser, referrerCode) {
            const userRef = doc(db, 'users', String(tgUser.id));
            const userSnap = await getDoc(userRef);
            
            const defaultUserData = {
                balance: 0, 
                createdAt: serverTimestamp(), 
                completedTasks: [],
                lastAdTask1Claim: null,
                lastAdTask2Claim: null,
                lastDailyBonusClaim: null
            };

            if (!userSnap.exists()) {
                const newUser = { ...defaultUserData };
                if (referrerCode) newUser.referredBy = referrerCode;
                await setDoc(userRef, newUser);
                currentUser = { id: tgUser.id, ...newUser };
            } else {
                currentUser = { id: userSnap.id, ...userSnap.data() };
                // Ensure all fields exist for older users
                for (const key in defaultUserData) {
                    if (!currentUser.hasOwnProperty(key)) {
                        currentUser[key] = defaultUserData[key];
                    }
                }
            }
            if (!currentUser.completedTasks) currentUser.completedTasks = [];
            
            updateBalanceUI(currentUser.balance);
            generateReferralLink(currentUser.id);
            processPendingVideoRewards(); // Check for rewards on startup
        }
        
        function updateBalanceUI(balance) {
            const points = Math.floor(balance || 0);
            document.getElementById('userBalanceDisplay').textContent = points;
            document.getElementById('withdrawalBalance').textContent = points;
        }

        // --- Referral Link Logic ---
        function generateReferralLink(userId) {
            document.getElementById('referralLinkInput').value = `https://t.me/NewTube12_bot?start=${userId}`;
        }
        
        document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
            const copyButton = document.getElementById('copyReferralLinkBtn');
            const linkInput = document.getElementById('referralLinkInput');
            navigator.clipboard.writeText(linkInput.value).then(() => {
                copyButton.textContent = 'Copied!';
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
            });
        });

        // --- Content Fetching & Video Player ---
        async function fetchContent(category, targetId) {
            const grid = document.querySelector(`${targetId} .item-grid`);
            grid.innerHTML = '<div class="loader"></div>';
            try {
                let q;
                const videosCollection = collection(db, 'videos');
                if (category === 'Home') q = query(videosCollection, orderBy('createdAt', 'desc'), limit(20));
                else if (category === 'Videos') q = query(videosCollection, orderBy('createdAt', 'desc'));
                else q = query(videosCollection, where('category', '==', category), orderBy('createdAt', 'desc'));
                
                const snapshot = await getDocs(q);
                grid.innerHTML = ''; 
                if (snapshot.empty) { grid.innerHTML = '<p style="text-align:center;">No content found.</p>'; return; }
                
                snapshot.forEach(doc => {
                    const video = doc.data();
                    const item = document.createElement('article');
                    item.className = 'movie-item';
                    item.dataset.youtubeId = video.youtubeId;
                    item.dataset.videoId = doc.id;
                    
                    item.originalContent = `<div class="thumbnail-container"><img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy"></div><div class="movie-item-info"><h4>${video.title}</h4></div>`;
                    item.innerHTML = item.originalContent;
                    item.addEventListener('click', handleVideoClick);
                    grid.appendChild(item);
                });
            } catch (error) { console.error("Error fetching content:", error); grid.innerHTML = '<p>Error loading content.</p>'; }
        }

        // --- NEW: Delayed Video Reward System ---
        async function handleVideoClick(event) {
            if (!currentUser) { alert("User data not loaded yet."); return; }
            const clickedItem = event.currentTarget;
            if (currentPlayingItem === clickedItem) return;

            if (currentPlayingItem) {
                currentPlayingItem.innerHTML = currentPlayingItem.originalContent;
                if (player) player.destroy(); player = null;
            }
            
            currentPlayingItem = clickedItem;
            const youtubeId = clickedItem.dataset.youtubeId;
            const videoId = clickedItem.dataset.videoId;

            // Add a pending reward instead of giving it instantly
            const pendingRewardRef = collection(db, 'users', currentUser.id, 'pendingVideoRewards');
            await addDoc(pendingRewardRef, {
                videoId: videoId,
                reward: 10, // Fixed 10 points
                clickTime: serverTimestamp()
            });

            const playerDivId = `player-${youtubeId}-${Date.now()}`;
            clickedItem.innerHTML = `<div id="${playerDivId}" class="player-container"></div>`;
            player = new YT.Player(playerDivId, { height: '100%', width: '100%', videoId: youtubeId, playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 } });
        }

        async function processPendingVideoRewards() {
            if (!currentUser) return;
            const pendingRewardsRef = collection(db, 'users', currentUser.id, 'pendingVideoRewards');
            const snapshot = await getDocs(pendingRewardsRef);
            const now = new Date();
            
            snapshot.forEach(async (docSnap) => {
                const rewardData = docSnap.data();
                const clickTime = rewardData.clickTime.toDate();
                const oneHour = 60 * 60 * 1000;

                if (now.getTime() - clickTime.getTime() > oneHour) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const userRef = doc(db, 'users', currentUser.id);
                            transaction.update(userRef, { balance: increment(rewardData.reward) });
                            if (currentUser.referredBy) {
                                const referrerRef = doc(db, 'users', currentUser.referredBy);
                                const commission = rewardData.reward * 0.001;
                                transaction.update(referrerRef, { balance: increment(commission) });
                            }
                            // Delete the pending reward doc inside the transaction
                            transaction.delete(docSnap.ref);
                        });
                        // Optimistically update local balance
                        currentUser.balance += rewardData.reward;
                        updateBalanceUI(currentUser.balance);
                    } catch (e) {
                        console.error("Failed to process pending reward:", e);
                    }
                }
            });
        }


        // --- NEW: Ads to Earn Logic ---
        function setupAdsToEarn() {
            const adTaskListContainer = document.getElementById('ad-task-list');
            const adTasks = [
                { id: 'adTask1', title: 'Daily Ad Pack 1', reward: 800, description: 'Watch 40 Ads' },
                { id: 'adTask2', title: 'Daily Ad Pack 2', reward: 1000, description: 'Watch 40 Ads' },
                { id: 'dailyBonus', title: 'Daily Bonus', reward: 150, description: 'Claim Once Daily' }
            ];

            adTaskListContainer.innerHTML = '';
            adTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'ad-task-card';
                card.innerHTML = `
                    <div class="ad-task-card-info">
                        <h4>${task.title}</h4>
                        <p>Reward: ${task.reward} Points</p>
                    </div>
                    <button class="ad-task-button" data-task-id="${task.id}" data-reward="${task.reward}">Claim Reward</button>`;
                adTaskListContainer.appendChild(card);
            });
        }

        document.getElementById('ad-task-list').addEventListener('click', async (e) => {
            if (!e.target.matches('.ad-task-button') || e.target.disabled) return;
            
            const button = e.target;
            const taskId = button.dataset.taskId;
            const reward = parseInt(button.dataset.reward);
            const lastClaimField = `last${taskId.charAt(0).toUpperCase() + taskId.slice(1)}Claim`;
            
            button.disabled = true;
            button.textContent = 'Checking...';

            // Check if claimable
            const lastClaimTimestamp = currentUser[lastClaimField];
            if (lastClaimTimestamp) {
                const lastClaimDate = lastClaimTimestamp.toDate();
                const now = new Date();
                if (lastClaimDate.getFullYear() === now.getFullYear() &&
                    lastClaimDate.getMonth() === now.getMonth() &&
                    lastClaimDate.getDate() === now.getDate()) {
                    alert("You have already claimed this today. Come back tomorrow!");
                    button.textContent = 'Claimed Today';
                    return;
                }
            }
            
            // Show ad
            if (adexiumWidget) {
                try { adexiumWidget.show(); } catch(err) { console.error("Ad failed to show", err); }
            }

            button.textContent = 'Processing...';

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, 'users', currentUser.id);
                    const updateData = { balance: increment(reward) };
                    updateData[lastClaimField] = serverTimestamp(); // Update the claim time
                    transaction.update(userRef, updateData);
                });

                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                alert(`Successfully claimed ${reward} points!`);
                
                // Update local user object and UI
                const updatedUser = await getDoc(doc(db, 'users', currentUser.id));
                currentUser = {id: updatedUser.id, ...updatedUser.data()};
                updateBalanceUI(currentUser.balance);
                button.textContent = 'Claimed Today';

            } catch (error) {
                alert("Failed to claim reward. Please try again.");
                console.error("Ad task claim error:", error);
                button.textContent = 'Claim Reward';
                button.disabled = false;
            }
        });


        // --- Task System (Original) ---
        const taskListContainer = document.getElementById('task-list');
        async function fetchTasks() {
            taskListContainer.innerHTML = '<div class="loader"></div>';
            const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            taskListContainer.innerHTML = '';
            if (snapshot.empty) { taskListContainer.innerHTML = '<p style="text-align:center;">No tasks available.</p>'; return; }

            snapshot.forEach(docSnap => {
                const task = { id: docSnap.id, ...docSnap.data() };
                if (task.completionCount >= task.limit) return;
                
                const card = document.createElement('div');
                card.className = 'task-card';
                card.innerHTML = `<div class="task-card-info"><h4>${task.title}</h4><p>Reward: ${task.reward} Points</p></div><button class="task-button" data-task-id="${task.id}">Go to Task</button>`;
                taskListContainer.appendChild(card);
                const button = card.querySelector('.task-button');
                if (currentUser.completedTasks.includes(task.id)) { button.textContent = 'Done'; button.disabled = true; }
            });
        }
        taskListContainer.addEventListener('click', async (e) => { /* Original task logic remains same, just uses points now */ });


        // --- Withdrawal Form & History Logic ---
        document.getElementById('withdrawalMethod').addEventListener('change', (e) => {
            document.getElementById('accountDetails').placeholder = e.target.value === 'Bkash' ? 'Your Bkash Number' : 'Your Binance Wallet Address (Optimism)';
        });
        
        document.getElementById('withdrawalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdrawalAmount').value, 10);
            const minWithdrawal = 100000;
            
            if (amount > currentUser.balance) { alert("Insufficient balance."); return; }
            if (amount < minWithdrawal) { alert(`Minimum withdrawal is ${minWithdrawal} Points.`); return; }
            
            const usdAmount = (amount / 1000) * 0.02;
            const request = { 
                userId: currentUser.id, 
                pointsAmount: amount,
                usdAmount: usdAmount.toFixed(2),
                method: document.getElementById('withdrawalMethod').value, 
                details: document.getElementById('accountDetails').value, 
                status: 'pending', 
                createdAt: serverTimestamp() 
            };
            
            await addDoc(collection(db, 'withdrawals'), request);
            const userRef = doc(db, 'users', currentUser.id);
            await runTransaction(db, async (t) => t.update(userRef, { balance: increment(-amount) }));
            
            currentUser.balance -= amount;
            updateBalanceUI(currentUser.balance);
            alert("Withdrawal request submitted!"); 
            e.target.reset();
            if(document.querySelector('.nav-link[data-tab-target="#history-content"]')) document.querySelector('.nav-link[data-tab-target="#history-content"]').click();
        });

        async function displayWithdrawalHistory() {
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = '<div class="loader"></div>';
            const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);

            historyContainer.innerHTML = '';
            if (snapshot.empty) { historyContainer.innerHTML = '<p style="text-align:center;">No withdrawal history found.</p>'; return; }
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.createdAt.toDate().toLocaleDateString();
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <strong>${data.pointsAmount} Points</strong><br>
                        <small>${data.method} - ${date}</small>
                    </div>
                    <strong class="status-${data.status}">${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</strong>`;
                historyContainer.appendChild(item);
            });
        }

        // --- Navigation & Initial Load ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPlayingItem) {
                    currentPlayingItem.innerHTML = currentPlayingItem.originalContent; currentPlayingItem = null;
                    if (player) { player.destroy(); player = null; }
                }

                document.querySelectorAll('.nav-link, .content-section').forEach(el => el.classList.remove('active'));
                link.classList.add('active');
                const target = document.querySelector(link.dataset.tabTarget);
                target.classList.add('active');

                if (link.dataset.category) fetchContent(link.dataset.category, link.dataset.tabTarget);
                if (link.dataset.tabTarget === '#task-content') fetchTasks();
                if (link.dataset.tabTarget === '#ads-to-earn-content') setupAdsToEarn();
                if (link.dataset.tabTarget === '#history-content') displayWithdrawalHistory();
                
                document.getElementById('side-menu').classList.remove('is-open');
                document.getElementById('menu-overlay').classList.remove('is-open');
            });
        });

        // --- Ads Setup Logic ---
        function setupAds() {
            if (typeof AdexiumWidget === 'undefined') { console.error("Adexium Ad library not loaded."); return; }
            adexiumWidget = new AdexiumWidget({ wid: '165512cc-372e-4fb0-98d2-552219c72799', adFormat: 'interstitial' });
            adexiumWidget.init();
            const showAd = () => { try { adexiumWidget.show(); } catch(e) { console.error("Failed to show ad:", e); } };
            setTimeout(() => { showAd(); setInterval(showAd, 4 * 60 * 1000); }, 30 * 1000); 
        }

        // --- App Initialization ---
        function init() {
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                document.body.innerHTML = `<div class="card" style="margin-top: 50px;"><h3>Error</h3><p>This application can only be launched from Telegram.</p></div>`;
                return;
            }
            tg.ready(); tg.expand();
            const tgUser = tg.initDataUnsafe.user;
            const referrerCode = tg.initDataUnsafe.start_param;

            initializeUser(tgUser, referrerCode).then(() => {
                document.querySelector('.nav-link[data-category="Home"]').click();
            });
            const menuToggleBtn = document.getElementById('menu-toggle-button'), closeMenuBtn = document.getElementById('close-menu-btn'), sideMenu = document.getElementById('side-menu'), menuOverlay = document.getElementById('menu-overlay');
            function toggleMenu() { sideMenu.classList.toggle('is-open'); menuOverlay.classList.toggle('is-open'); }
            [menuToggleBtn, closeMenuBtn, menuOverlay].forEach(el => el.addEventListener('click', toggleMenu));
            
            setupAds();
        }
        
        init();
    </script>
</body>
</html>