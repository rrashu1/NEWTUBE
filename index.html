<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NEWTUBE - Watch & Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <!-- Adexium Ads SDK -->
    <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const adexiumWidget = new AdexiumWidget({wid: '12c05dba-2642-46f2-950f-cee6575119c9', adFormat: 'interstitial'});
                adexiumWidget.autoMode();
            } catch (e) {
                console.error("Adexium SDK failed to initialize:", e);
            }
        });
    </script>
    
    <!-- Other Ad Libraries -->
    <script src='//libtl.com/sdk.js' data-zone='9442539' data-sdk='show_9442539'></script>
    <script src="https://ad.gigapub.tech/script?id=846"></script>
    <!-- Adextra Ad Script -->
    <script async src="https://partner.adextra.io/jt/fa6b30e404e1046793d70db4a424966f97960abe.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* --- UPDATE 6: THEME REDESIGN (WHITE & YELLOW) --- */
            --primary-accent-color: #FFC107; /* Yellow */
            --primary-accent-hover-color: #E0A800; /* Darker Yellow */
            --light-bg: #F4F4F9; /* Light base background */
            --card-bg: #FFFFFF; /* White for cards, headers */
            --header-bg: #FFFFFF;
            --text-dark: #1F1F1F; /* Dark text color */
            --text-muted: #6c757d; /* Muted gray text */
            --border-color: #E0E0E0; /* Light gray for borders */
            --success-color: #28a745;
            --disabled-color: #E9ECEF;
            --disabled-text-color: #6c757d;
        }
        body { 
            background-color: var(--light-bg); 
            color: var(--text-dark); 
            font-family: 'Poppins', sans-serif;
            margin: 0; 
            padding: 70px 0 90px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        
        /* --- UPDATE 1: HEADER REWORK --- */
        .main-header { 
            background-color: var(--header-bg); 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--border-color); 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 50px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .site-branding { display: flex; flex-direction: column; align-items: flex-start; }
        .site-title { font-size: 1.4em; color: var(--primary-accent-color); font-weight: 700; margin: 0; line-height: 1; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .user-id-display { font-size: 0.65em; color: var(--text-muted); font-family: 'Roboto Mono', monospace; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 2px 4px; border-radius: 4px; transition: background-color .2s;}
        .user-id-display:hover { background-color: #f0f0f0; }
        .user-id-display .copy-icon { width: 12px; height: 12px; }
        
        .header-right { display: flex; align-items: center; gap: 15px; }
        .balance-display { background-color: rgba(255, 193, 7, 0.15); color: var(--text-dark); padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9em; }
        .balance-display .usdt-label { color: var(--primary-accent-color); font-weight: 700; }
        .header-icon-btn { position: relative; cursor: pointer; background: none; border: none; color: var(--text-dark); padding: 5px; }
        .header-icon-btn svg { width: 26px; height: 26px; }

        .profile-popover {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            padding: 15px;
            width: 300px;
            z-index: 1001;
            border: 1px solid var(--border-color);
            display: none; /* Toggled by JS */
            flex-direction: column;
            gap: 12px;
            animation: fadeInDown 0.3s ease-out;
        }
        .profile-popover.show { display: flex; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-popover-item { font-size: 0.9em; }
        .profile-popover-item strong { font-weight: 600; color: var(--text-dark); display: block; margin-bottom: 2px; }
        .profile-popover-item span, .profile-popover-item input { font-family: 'Roboto Mono', monospace; color: var(--text-muted); }
        .popover-ref-link { display: flex; gap: 8px; }
        .popover-ref-link input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 8px; font-size: 0.9em; background-color: var(--light-bg); }
        .popover-ref-link button { padding: 6px 10px; border: none; border-radius: 6px; background-color: var(--primary-accent-color); color: #000; font-weight: 600; cursor: pointer; font-size: 0.8em; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
        }
        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; color: var(--text-muted); text-decoration: none;
            font-size: 0.75rem; font-weight: 500;
            padding: 5px 10px; border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .bottom-nav-item svg { width: 24px; height: 24px; }
        .bottom-nav-item:hover { color: var(--primary-accent-color); }
        .bottom-nav-item.active { color: var(--primary-accent-color); }

        .content-section { display: none; padding-top: 25px; } 
        .content-section.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title { font-size: 1.6em; margin-bottom: 25px; padding-bottom: 10px; color: var(--text-dark); border-bottom: 2px solid var(--border-color); font-weight: 600; }
        .sub-section-title { font-size: 1.2em; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 40px; margin-bottom: 20px; font-weight: 500; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-container input { flex-grow: 1; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-dark); font-size: 1em; }
        .search-container button { padding: 12px 18px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: #000; font-weight: bold; cursor: pointer; }
        .search-container button#clearSearchBtn { background-color: #6c757d; color: #fff; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        .movie-item, .ad-task-card, .task-card, .ad-package-card, .user-ad-item, .withdraw-package-card { background-color: var(--card-bg); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .movie-item { cursor: pointer; } 
        .movie-item:hover{ transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .thumbnail-container { width: 100%; aspect-ratio: 16/9; background-color: #e0e0e0; position: relative; }
        .thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; }
        .player-container iframe { width: 100%; height: 100%; border: none; }
        .movie-item-info, .ad-task-card-info { padding: 15px; flex-grow: 1; text-align:center;}
        .movie-item-info h4, .ad-task-card h4, .ad-package-card h4, .user-ad-item h4 { margin: 0 0 8px; font-size: 1.1em; line-height: 1.3; }
        .movie-reward { color: var(--success-color); font-weight: bold; font-size: 0.9em; margin: 0; }
        
        .ad-task-card p { margin: 8px 0 15px; color: var(--text-muted); font-weight: bold; }
        .task-reward-usdt { color: var(--success-color); }
        .ad-task-button { width: 100%; padding: 12px; border: none; border-radius: 0 0 10px 10px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: #000; transition: background-color .2s; margin-top: auto; font-size: 1em;}
        .task-button, .daily-task-button { width: auto; flex-shrink: 0; padding: 10px 20px; font-size: 0.9em; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; background-color: var(--primary-accent-color); color: #000; transition: background-color .2s; margin-top: 0; }
        .task-button:disabled, .ad-task-button:disabled, .daily-task-button:disabled { background-color: var(--disabled-color); color: var(--disabled-text-color); cursor: not-allowed; }
        
        .card { max-width: 500px; margin: 20px auto; background-color: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-icon { width: 50px; height: 50px; margin: 0 auto 15px; color: var(--primary-accent-color); }
        .card h3 { margin-top: 0; font-size: 1.4em; } .card p { color: var(--text-muted); line-height: 1.6; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--light-bg); color: var(--text-dark); font-size: 1em; }
        .form-button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-accent-color); color: #000; font-weight: bold; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        .form-button:hover:not(:disabled) { background-color: var(--primary-accent-hover-color); }
        .form-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; color: var(--disabled-text-color); }
        
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: var(--card-bg); color: var(--text-dark); padding: 30px 40px; border-radius: 15px; text-align: center; transform: scale(0.9); opacity: 0; animation: modal-pop-in 0.3s forwards; max-width: 90%; width: 450px; border: 1px solid var(--border-color); }
        @keyframes modal-pop-in { to { transform: scale(1); opacity: 1; } }
        .success-modal-icon { width: 70px; height: 70px; border-radius: 50%; background-color: var(--success-color); display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold; color: white; margin: 0 auto 20px; animation: icon-pop-in 0.5s 0.2s backwards; }
        @keyframes icon-pop-in { 0% { transform: scale(0); } 70% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .modal-content h3 { margin: 0 0 10px; font-size: 1.6em; }
        .modal-content p { margin: 0; color: var(--text-muted); font-size: 1em; white-space: pre-wrap;}
        .history-modal, .task-modal, .notice-modal, .task-confirm-modal { background-color: var(--card-bg); color: var(--text-dark); padding: 20px; border-radius: 15px; text-align: left; width: 90%; max-height: 90vh; display: flex; flex-direction: column; }
        .notice-modal { max-width: 400px; }
        .history-modal, .task-modal, .task-confirm-modal { max-width: 500px; }
        .history-modal h3, .task-modal h3, .notice-modal h3, .task-confirm-modal h3 { text-align: center; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #combined-history-list, .task-modal .modal-body, .notice-modal .modal-body, .task-confirm-modal .modal-body { overflow-y: auto; flex-grow: 1; margin-bottom: 15px; }
        .task-confirm-modal .modal-body { text-align: center; }
        .task-confirm-modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .task-confirm-modal-buttons button { flex: 1; }
        .notice-modal .modal-body ul { padding-left: 20px; list-style-type: '✓ '; }
        .notice-modal .modal-body li { margin-bottom: 10px; line-height: 1.6; }
        
        .info-text { font-size: 0.9em; color: var(--text-muted); margin-top: 10px; line-height: 1.5; }
        
        .task-card { background-color: var(--card-bg); border-radius: 8px; display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 15px; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; border: 1px solid var(--border-color); }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15); }
        #ad-task-list.item-grid, #task-list.item-grid, #my-ads-list.item-grid { grid-template-columns: 1fr; gap: 15px; display: grid;} 
        .task-card-info { padding: 0; flex-grow: 1; text-align: left; }
        .task-card-info h4 { margin: 0 0 5px; font-size: 1em;}
        .task-card-info p { margin: 5px 0 0; font-size: 0.9em; }

        .history-list-container { display: flex; flex-direction: column; gap: 0; }
        .history-date-header { padding: 15px 5px 5px; color: var(--text-muted); font-weight: 600; font-size: 0.9em; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .history-list-container .history-item:last-child { border-bottom: none; }
        .history-item-left strong { font-size: 1em; font-weight: 500; color: var(--text-dark); }
        .history-item-left small { font-size: 0.85em; color: var(--text-muted); display: block; margin-top: 4px; }
        .history-item-right { text-align: right; }
        .history-item-right strong { font-size: 1em; font-weight: bold; }
        .history-item-right small { font-size: 0.85em; display: block; margin-top: 4px; text-transform: capitalize; }
        .history-item-right .amount-positive { color: var(--success-color); }
        .history-item-right .amount-negative { color: #dc3545; }
        .history-item-right .status-success { color: var(--success-color); font-weight: 600; }
        .history-item-right .status-pending { color: #ffc107; font-weight: 600; }
        .history-item-right .status-failed, .history-item-right .status-rejected { color: #dc3545; font-weight: 600; }
        
        .ad-package-card { padding: 15px; text-align: center; cursor: pointer; border: 2px solid var(--border-color); transition: all 0.2s ease-in-out; }
        .ad-package-card h4 { font-size: 1.1em; margin-bottom: 5px; }
        .ad-package-card p { margin: 0; font-weight: 600; color: var(--primary-accent-color); }
        .ad-package-card.selected { border-color: var(--primary-accent-color); background-color: rgba(255, 193, 7, 0.1); transform: translateY(-3px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
        .user-ad-item { padding: 20px; text-align: left; }
        .user-ad-item .progress-text { font-weight: bold; color: var(--primary-accent-color); margin-top: 10px; display: block; }
        .user-ad-item .status-text { font-weight: 600; margin-top: 5px; display: block; }
        .user-ad-item .status-text.completed { color: var(--success-color); }
        .user-ad-item .status-text.active { color: var(--primary-accent-color); }
        #ad-package-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 600px) { #ad-package-grid { grid-template-columns: repeat(2, 1fr); } }
        
        /* --- UPDATE 3: LOOT BOX STYLES --- */
        #video-loot-box {
            position: fixed;
            bottom: 100px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 1001;
            transform: scale(0);
            transition: transform 0.3s ease-in-out;
        }
        #video-loot-box.visible { transform: scale(1); }
        #video-loot-box.pulsate { animation: pulsate-animation 1.5s infinite; }
        @keyframes pulsate-animation {
            0% { transform: scale(1); box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4); }
            100% { transform: scale(1); box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2); }
        }
        #video-loot-box #video-unclaimed-balance-box { 
            font-size: 1em; font-weight: 700; color: var(--primary-accent-color); display: block; margin-bottom: 8px; 
        }
        #video-loot-box #video-claim-button-box { 
            width: 100%; padding: 6px 12px; font-size: 0.9em; 
        }

        .coin-vfx {
            position: absolute;
            background-color: var(--primary-accent-color);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.8;
            animation: fly-to-box 0.7s ease-in-out forwards;
        }
        @keyframes fly-to-box {
            0% { transform: translate(0, 0) scale(1); opacity: 0.8; }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(0); opacity: 0; }
        }

        /* --- UPDATE 7: WITHDRAWAL SECTION STYLES --- */
        #withdraw-content .card { max-width: 600px; }
        .withdraw-summary { margin-top: 20px; padding: 15px; background-color: var(--light-bg); border-radius: 8px; text-align: left; font-size: 0.9em; }
        .withdraw-summary p { margin: 8px 0; display: flex; justify-content: space-between; }
        .withdraw-summary strong { color: var(--text-dark); }
        
        /* --- UPDATE 8: SUPPORT SECTION STYLES --- */
        #support-content .card { text-align: left; max-width: 700px; }
        #support-content ul { padding-left: 20px; list-style-type: '✓ '; color: var(--text-muted); }
        #support-content li { margin-bottom: 10px; line-height: 1.6; }
        #support-content .admin-contact { font-weight: 600; color: var(--primary-accent-color); }

    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-left">
            <div class="site-branding">
                <h1 class="site-title">NEWTUBE</h1>
                <div class="user-id-display" id="header-user-id">
                    <span>ID: Loading...</span>
                    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </div>
            </div>
            <!-- UPDATE 1: Profile Icon with Popover -->
            <div id="profile-icon-wrapper" style="position: relative;">
                <button class="header-icon-btn" id="profile-info-btn" title="My Info">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </button>
                <div id="profile-popover" class="profile-popover">
                    <div class="profile-popover-item">
                        <strong>Referral Link</strong>
                        <div class="popover-ref-link">
                            <input type="text" id="popoverReferralLinkInput" readonly value="Loading...">
                            <button id="popoverCopyRefLinkBtn">Copy</button>
                        </div>
                    </div>
                    <div class="profile-popover-item">
                        <strong>Total Referrals</strong>
                        <span id="popover-total-referrals">0</span>
                    </div>
                    <div class="profile-popover-item">
                        <strong>Total USDT Earned</strong>
                        <span id="popover-total-usdt-earned">$0.0000</span>
                    </div>
                    <div class="profile-popover-item">
                        <strong>Total Tasks Done ✅</strong>
                        <span id="popover-total-tasks-done">0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="balance-display"><span class="usdt-label">$</span> <span id="userUSDTBalanceDisplay">0.0000</span></div>
            <button class="header-icon-btn" id="history-btn" title="History">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            </button>
        </div>
    </header>

    <main class="container">
        <!-- Home / Main Section -->
        <section id="home-content" class="content-section active">
             <h3 class="section-title">Daily Rewards</h3>
             <div id="daily-tasks-grid" class="item-grid" style="grid-template-columns: 1fr; gap: 15px;">
                 <!-- Daily tasks will be rendered here by JS -->
             </div>
        </section>
        
        <section id="ads-content" class="content-section">
             <h3 class="section-title">Watch Ads, Earn Rewards</h3>
             <div id="ad-task-list" class="item-grid" style="grid-template-columns: 1fr; gap: 15px;"></div>
             <!-- Adextra Banner Ad Block -->
             <div id="fa6b30e404e1046793d70db4a424966f97960abe" style="margin-top: 25px;"></div>
        </section>

        <section id="video-content" class="content-section">
            <h3 class="section-title">Trending Videos</h3>
            <div class="search-container">
                <input type="search" id="videoSearchInput" placeholder="Search for videos...">
                <button id="videoSearchBtn">Search</button>
                <button id="clearSearchBtn" style="display:none;">Clear</button>
            </div>
            <div class="item-grid" id="video-grid"></div>
        </section>

        <section id="task-content" class="content-section">
            <h3 class="section-title">Complete Tasks to Earn</h3>
            
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 20px;">
                <h3 class="sub-section-title" style="margin: 0; border: none; padding: 0; font-size: 1.1em;">Available Tasks</h3>
                <button id="show-create-task-btn" class="task-button">Add Task +</button>
            </div>
            
            <div id="task-list" class="item-grid"></div>

             <!-- My Ads Section -->
             <div id="my-ads-section-container">
                <h3 class="sub-section-title">My Advertisements</h3>
                <div id="my-ads-list" class="item-grid"></div>
            </div>
        </section>
        
        <!-- UPDATE 7: NEW WITHDRAWAL SECTION -->
        <section id="withdraw-content" class="content-section">
             <div class="card">
                <h3 class="section-title" style="border: none; margin-bottom: 10px; text-align: center;">Withdraw Funds</h3>
                <p>Your Balance: <strong id="withdrawUsdtBalance" style="color: var(--success-color); font-size: 1.2em;">$0.0000</strong></p>
                <p class="info-text" style="text-align: center; margin-bottom: 25px;">
                    Withdrawals are processed within 1-5 hours.
                </p>
                
                <form id="withdrawalForm" style="margin-top: 20px;">
                     <div class="form-group">
                        <label for="withdrawalMethod">1. Select Payment Method</label>
                        <select id="withdrawalMethod" required>
                            <option value="Bkash">Bkash</option>
                            <option value="Nagad">Nagad</option>
                            <option value="Binance">Binance ID</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <label for="withdrawalAmount">2. Enter Amount (USDT)</label>
                        <input type="number" id="withdrawalAmount" step="0.01" placeholder="e.g., 0.50" required>
                     </div>
                     <div class="form-group">
                        <label for="accountDetails">3. Enter Account Details</label>
                        <input type="text" id="accountDetails" placeholder="Your Bkash/Nagad Number or Binance ID" required>
                     </div>

                     <div id="withdraw-summary" class="withdraw-summary" style="display: none;">
                        <p><span>Minimum Withdrawal:</span> <strong id="summary-min"></strong></p>
                        <p><span>Withdrawal Fee:</span> <strong id="summary-fee"></strong></p>
                        <p><span>You Will Receive:</span> <strong id="summary-receive"></strong></p>
                     </div>
                </form>

                <button id="submitWithdrawalBtn" class="form-button" style="margin-top: 20px;">Submit Withdrawal Request</button>
             </div>
        </section>

        <!-- UPDATE 8: NEW SUPPORT SECTION -->
        <section id="support-content" class="content-section">
            <div class="card">
                <h3>Support & Guidelines</h3>
                <p>
                    Welcome to our support center. We are here to help you with any issues or questions you may have. For the fastest response, please contact our administrator directly on Telegram.
                </p>
                
                <h4 class="sub-section-title" style="margin-top: 30px;">Admin Contact</h4>
                <p>
                    For any promotion, payment-related issues, or general inquiries, please contact:
                    <a href="https://t.me/newtube12_Admin" target="_blank" class="admin-contact">@newtube12_Admin</a>
                </p>
                
                <h4 class="sub-section-title" style="margin-top: 30px;">Rules and Guidelines</h4>
                <ul>
                    <li>Please work honestly and with integrity.</li>
                    <li>Submitting fake or incomplete tasks will lead to account suspension without warning.</li>
                    <li>The use of VPNs, proxies, or any other methods to fake your location is strictly prohibited and will result in a permanent ban.</li>
                    <li>You can only request a withdrawal after reaching the minimum required amount for your chosen method.</li>
                    <li>For business promotions or manual deposits, please contact the administrator directly.</li>
                </ul>
            </div>
        </section>
        
    </main>

    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active" data-tab-target="#home-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Home
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#ads-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM8 11H6V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg>
            Ads
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#video-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 16.5v-9l6 4.5-6 4.5zM20 4.44v15.12c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V4.44c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2z"/></svg>
            Video
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#task-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 7h-9v-2h9v2zm0 4h-9v-2h9v2zm0 4h-9v-2h9v2zm-11-8H4v6h7V7zM3 5h9v14H3V5z"/></svg>
            Tasks
        </a>
        <a href="#" class="bottom-nav-item" data-tab-target="#withdraw-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm14 0v-2h-2v2h-2v2h2v2h2v-2h2v-2zM2 18h18V6H2v12zm20-14v16H0V4h22z"/></svg>
            Withdraw
        </a>
        <!-- UPDATE 8: Support Nav Item -->
        <a href="#" class="bottom-nav-item" data-tab-target="#support-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Support
        </a>
    </nav>
    
    <!-- UPDATE 3: Video Loot Box -->
    <div id="video-loot-box">
        <span id="video-unclaimed-balance-box">$0.0000 / $0.0200</span>
        <button id="video-claim-button-box" class="form-button" disabled>Claim</button>
    </div>

    <div id="successModalOverlay" class="modal-overlay"><div class="modal-content"><div class="success-modal-icon">✓</div><h3 id="successModalTitle">Success!</h3><p id="successModalMessage">Your request has been sent.</p></div></div>
    
    <div id="historyModalOverlay" class="modal-overlay">
        <div class="history-modal"><h3>History</h3><div id="combined-history-list" class="history-list-container"></div><button id="closeHistoryBtn" class="form-button" style="margin-top: 15px;">Close</button></div>
    </div>
    
    <div id="createTaskModalOverlay" class="modal-overlay">
        <div class="task-modal">
            <h3>Create New Task Advertisement</h3>
            <div class="modal-body">
                <p class="info-text" style="text-align: center; margin-bottom: 20px;">
                    Purchase tasks using your USDT balance. Your task will be shown to thousands of our active users.<br>
                    <strong>For manual deposits or promotions, contact admin: <a href="https://t.me/NEWTUBE12_admin" target="_blank" style="color: var(--primary-accent-color);">@NEWTUBE12_admin</a></strong>
                </p>
                <form id="create-task-form">
                    <div class="form-group">
                        <label>1. Select a Package</label>
                        <div id="ad-package-grid" class="item-grid"></div>
                    </div>
                    <div class="form-group">
                        <label for="task-title-input">2. Task Title</label>
                        <input type="text" id="task-title-input" placeholder="e.g., Join My Telegram Channel" required>
                    </div>
                    <div class="form-group">
                        <label for="task-url-input">3. Task URL</label>
                        <input type="url" id="task-url-input" placeholder="https://t.me/your_channel" required>
                    </div>
                    <button type="submit" class="form-button">Create Task</button>
                </form>
            </div>
            <button id="closeTaskModalBtn" class="form-button" style="margin-top: 15px; background-color: var(--text-muted);">Close</button>
        </div>
    </div>

    <div id="noticeModalOverlay" class="modal-overlay">
        <div class="notice-modal">
            <h3>Welcome to NEWTUBE! 🤗</h3>
            <div class="modal-body">
                <p>Here’s what you can do on our platform:</p>
                <ul>
                    <li>Run your own advertisements starting from just 60 Taka.</li>
                    <li>Earn USDT by watching videos and withdraw your earnings instantly.</li>
                    <li>Receive a 10% lifetime commission for every friend you refer.</li>
                    <li>Withdrawals are processed within 1-5 hours.</li>
                    <li>Using a VPN is strictly prohibited. You will not receive any payment if you do.</li>
                    <li>Submitting fake or incomplete tasks will lead to account suspension.</li>
                    <li>Please work honestly, share with friends to earn more, and enjoy your halal income.</li>
                </ul>
            </div>
            <button id="noticeConfirmBtn" class="form-button">I Understand</button>
        </div>
    </div>

    <div id="taskConfirmModalOverlay" class="modal-overlay">
        <div class="task-confirm-modal">
            <h3>Confirm Task Completion</h3>
            <div class="modal-body">
                <p>Have you completed the task correctly? If not, please go back and complete it now.</p>
                <p class="info-text">Note: Your submission may be reviewed. Failure to complete tasks honestly can result in account suspension.</p>
                <div class="task-confirm-modal-buttons">
                    <button id="taskConfirmGoBackBtn" class="form-button" style="background-color: var(--text-muted);">Go Back to Task</button>
                    <button id="taskConfirmSubmitBtn" class="form-button">Yes, I Completed It</button>
                </div>
            </div>
        </div>
    </div>

    <div id="withdrawConfirmModalOverlay" class="modal-overlay">
        <div class="task-confirm-modal">
            <h3>Confirm Withdrawal</h3>
            <div class="modal-body">
                <p id="withdrawConfirmText">Are you sure you want to withdraw X USDT?</p>
                <p class="info-text">The amount will be sent to the account details you provided. This action cannot be undone.</p>
                <div class="task-confirm-modal-buttons">
                    <button id="withdrawConfirmCancelBtn" class="form-button" style="background-color: var(--text-muted);">Cancel</button>
                    <button id="withdrawConfirmSubmitBtn" class="form-button">Confirm & Withdraw</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api" async></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc, serverTimestamp, doc, getDoc, setDoc, updateDoc, runTransaction, increment, arrayUnion, Timestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCKMa4NdIowD_8NioUbrn4L7g5M9y5Tts0",
            authDomain: "movie-zone-931d7.firebaseapp.com",
            databaseURL: "https://movie-zone-931d7-default-rtdb.firebaseio.com",
            projectId: "movie-zone-931d7",
            storageBucket: "movie-zone-931d7.appspot.com",
            messagingSenderId: "1006880112063",
            appId: "1:1006880112063:web:4a4cf5079ea365a6ce750a",
            measurementId: "G-TH1YSE4D9C"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let currentUser = null;
        let player;
        let currentPlayingItem = null;
        let videoWatchTimer = null;
        let videoSyncTimer = null;
        let isSubmittingWithdrawal = false; 
        let selectedAdPackage = null;
        
        // --- UPDATED CONSTANTS ---
        // UPDATE 3: Video Mining/Loot Box System
        const LOOT_BOX_THRESHOLD = 0.02; // USDT
        const DAILY_VIDEO_EARNING_LIMIT = 0.04; // USDT
        const VIDEO_REWARD_PER_SECOND = DAILY_VIDEO_EARNING_LIMIT / 86400; // USDT per second

        // UPDATE 5: Ads Section Upgrade
        const AD_REWARD_USDT = 0.0007;
        const ADS_PER_SET = 15;
        const MAX_DAILY_ADS = ADS_PER_SET * 2;
        
        // UPDATE 2: Remove PG Coin, all rewards in USDT
        const DAILY_LOGIN_USDT_REWARD = 0.002;
        const USER_CREATED_TASK_REWARD_USDT = 0.005;
        const REFERRAL_COMMISSION_RATE = 0.10; // 10% commission

        // UPDATE 7: Withdrawal Config
        const WITHDRAWAL_CONFIG = {
            'Bkash': { min: 0.10, fee: 0.02 },
            'Nagad': { min: 0.10, fee: 0.02 },
            'Binance': { min: 0.30, fee: 0.05 },
        };

        const adPackages = [
            { id: 1, tasks: 100, price: 0.30 }, { id: 2, tasks: 200, price: 0.50 },
            { id: 3, tasks: 500, price: 1.10 }, { id: 4, tasks: 1000, price: 2.00 },
            { id: 5, tasks: 2000, price: 3.50 }, { id: 6, tasks: 5000, price: 7.00 }
        ];

        function showBanScreen() { document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; padding: 20px; text-align: center;"><div class="card"><h3>Account Banned</h3><p style="color: #ffc107;">Your account has been banned due to a violation of our terms of service.</p></div></div>`; }
        
        async function cleanupAndGetUser(userId) {
            const userRef = doc(db, 'users', userId);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) return null;
            return { id: userSnap.id, ...userSnap.data() };
        }

        async function fetchAndUpdateCurrentUser() {
            if (!currentUser?.id) return;
            try {
                const updatedUser = await cleanupAndGetUser(currentUser.id);
                if (updatedUser) {
                    currentUser = updatedUser;
                    updateBalanceUI(currentUser.usdtBalance);
                }
            } catch (error) { console.error("Error fetching/cleaning current user:", error); }
        }
        
        async function checkAndResetDailies() {
            if (!currentUser) return;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const lastDailyReset = currentUser.lastDailyReset?.toDate();
            const lastDailyResetTime = lastDailyReset ? new Date(lastDailyReset.getFullYear(), lastDailyReset.getMonth(), lastDailyReset.getDate()).getTime() : 0;
            
            if (!lastDailyReset || lastDailyResetTime < today) {
                const updates = { 
                    'lastDailyReset': serverTimestamp(), 
                    'claimedDailyRewards': [],
                    'dailyTelegramVisit1Completed': false,
                    'dailyTelegramVisit2Completed': false,
                    'dailyBrowseVisit1Completed': false,
                    'dailyBrowseVisit2Completed': false,
                    'dailyAdViews_set1': 0, 
                    'dailyAdViews_set2': 0,
                    'totalVideoWatchSecondsToday': 0,
                };
                try {
                    const userRef = doc(db, 'users', currentUser.id);
                    await updateDoc(userRef, updates);
                    await fetchAndUpdateCurrentUser(); 
                } catch (error) { console.error("Error resetting daily limits:", error); }
            }
        }

        async function grantCommission(rewardUsdt) {
            if (!currentUser.referredBy || !rewardUsdt || rewardUsdt <= 0) return;
            const referrerId = currentUser.referredBy;
            const commissionAmount = rewardUsdt * REFERRAL_COMMISSION_RATE;

            if (commissionAmount > 0) {
                try {
                    const referrerRef = doc(db, 'users', referrerId);
                    await runTransaction(db, async (t) => {
                         t.update(referrerRef, {
                            usdtBalance: increment(commissionAmount),
                            lifetimeCommissionUsdt: increment(commissionAmount)
                        });
                        const transactionData = {
                            userId: referrerId,
                            type: 'Commission',
                            details: `Commission from user ${currentUser.id}`,
                            usdAmount: commissionAmount,
                            status: 'Completed',
                            createdAt: serverTimestamp()
                        };
                        t.set(doc(collection(db, 'transactions')), transactionData);
                    });
                } catch (error) { console.error(`Failed to grant commission to ${referrerId}:`, error); }
            }
        }

        async function initializeUser(tgUser, referrerCode) {
            const userId = String(tgUser.id);
            const userRef = doc(db, 'users', userId);
            let userSnap = await getDoc(userRef);
            let isNewUser = false;

            if (!userSnap.exists()) {
                isNewUser = true;
                const defaultUserData = {
                    usdtBalance: 0, lifetimeUsdtEarned: 0, referralCount: 0,
                    lifetimeCommissionUsdt: 0,
                    completedTasks: [], 
                    lastDailyReset: serverTimestamp(),
                    lastNoticeShown: null,
                    createdAt: serverTimestamp(), telegramUsername: tgUser.username || 'N/A',
                    isBanned: false,
                    claimedDailyRewards: [],
                    dailyTelegramVisit1Completed: false, dailyTelegramVisit2Completed: false,
                    dailyBrowseVisit1Completed: false, dailyBrowseVisit2Completed: false,
                    dailyAdViews_set1: 0, dailyAdViews_set2: 0,
                    totalVideoWatchSecondsToday: 0,
                    unclaimedVideoUsdt: 0,
                };
                if (referrerCode && referrerCode !== userId) { 
                    defaultUserData.referredBy = referrerCode; 
                    try {
                        const referrerRef = doc(db, 'users', referrerCode);
                        await updateDoc(referrerRef, { referralCount: increment(1) });
                    } catch (e) { console.error("Failed to update referrer stats", e); }
                }
                await setDoc(userRef, defaultUserData);
                userSnap = await getDoc(userRef);
            }
            
            const userData = userSnap.data();
            if (userData?.isBanned === true) { showBanScreen(); return null; }
            
            // --- Field migration/check logic ---
            const updates = {};
            if (userData.lifetimeUsdtEarned === undefined) updates.lifetimeUsdtEarned = userData.lifetimePgCoinEarned || 0;
            if (userData.lifetimeCommissionUsdt === undefined) updates.lifetimeCommissionUsdt = userData.lifetimeCommissionPg || 0;
            if (userData.unclaimedVideoUsdt === undefined) updates.unclaimedVideoUsdt = userData.unclaimedVideoPg || 0;
            // Add new fields if they don't exist for old users
            if (userData.dailyAdViews_set1 === undefined) updates.dailyAdViews_set1 = 0;
            if (userData.dailyAdViews_set2 === undefined) updates.dailyAdViews_set2 = 0;

            if (Object.keys(updates).length > 0) { await updateDoc(userRef, updates); }
            
            currentUser = { id: userSnap.id };
            await fetchAndUpdateCurrentUser(); 
            
            await checkAndResetDailies();
            generateReferralLink(currentUser.id);
            
            return { isNewUser };
        }

        function updateBalanceUI(usdtBalance) {
            document.getElementById('userUSDTBalanceDisplay').textContent = parseFloat(usdtBalance || 0).toFixed(4);
        }
        
        function generateReferralLink(userId) {
            const botUsername = "NewTube12_bot";
            const webAppShortName = "newtubecash";
            const referralLink = `https://t.me/${botUsername}/${webAppShortName}?startapp=${userId}`;
            document.getElementById('popoverReferralLinkInput').value = referralLink;
        }
        
        async function grantReward(rewards, transactionInfo = {}) {
             if (!currentUser) return;
             const userRef = doc(db, 'users', currentUser.id);
             const updates = {};
             
             if (rewards.usdt && rewards.usdt > 0) { 
                 updates.usdtBalance = increment(rewards.usdt); 
                 updates.lifetimeUsdtEarned = increment(rewards.usdt);
             }
             
             if (Object.keys(updates).length > 0) { 
                await updateDoc(userRef, updates); 
             }
             
             if (transactionInfo.type) {
                 const transactionData = {
                    userId: currentUser.id, type: transactionInfo.type, details: transactionInfo.details || '',
                    status: 'Completed', createdAt: serverTimestamp(), usdAmount: rewards.usdt
                };
                await addDoc(collection(db, 'transactions'), transactionData);
             }
             // Grant commission AFTER main reward is granted
             if (rewards.usdt && rewards.usdt > 0) {
                 await grantCommission(rewards.usdt);
             }
             await fetchAndUpdateCurrentUser();
        }
        
        async function fetchContent() {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '<div class="loader"></div>';
            try {
                const q = query(collection(db, 'videos'), orderBy('createdAt', 'desc'), limit(30));
                const snapshot = await getDocs(q);
                renderVideos(snapshot);
            } catch (error) { 
                console.error("Error fetching content:", error); 
                grid.innerHTML = '<p style="grid-column: 1 / -1;">Error loading content.</p>'; 
            }
        }
        
        function renderVideos(snapshot) {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = ''; 
            if (snapshot.empty) { grid.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">No videos found.</p>'; return; }
            snapshot.docs.forEach((docSnap) => {
                const video = docSnap.data();
                const item = document.createElement('article');
                item.className = 'movie-item';
                item.dataset.youtubeId = video.youtubeId;
                item.dataset.videoId = docSnap.id;
                item.originalContent = `<div class="thumbnail-container"><img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy"></div><div class="movie-item-info"><h4>${video.title}</h4><p class="movie-reward">Watch to Earn USDT</p></div>`;
                item.innerHTML = item.originalContent;
                item.addEventListener('click', handleVideoClick);
                grid.appendChild(item);
            });
        }
        
        function handleVideoClick(event) {
            if (currentPlayingItem) {
                if(currentPlayingItem.originalContent) currentPlayingItem.innerHTML = currentPlayingItem.originalContent;
                if (player) { player.destroy(); player = null; }
            }
            const clickedItem = event.currentTarget;
            if (currentPlayingItem === clickedItem) { currentPlayingItem = null; return; }
            currentPlayingItem = clickedItem;
            const { youtubeId } = clickedItem.dataset;
            const playerDivId = `player-${youtubeId}-${Date.now()}`;
            clickedItem.innerHTML = `<div id="${playerDivId}" class="player-container"></div>`;
            player = new YT.Player(playerDivId, {
                height: '100%', width: '100%', videoId: youtubeId,
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'fs': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        
        // --- UPDATE 3: Video Loot Box Logic ---
        function updateVideoLootBoxUI() {
            const lootBox = document.getElementById('video-loot-box');
            const unclaimedBalanceEl = document.getElementById('video-unclaimed-balance-box');
            const claimButton = document.getElementById('video-claim-button-box');

            const unclaimedBalance = currentUser?.unclaimedVideoUsdt || 0;

            unclaimedBalanceEl.textContent = `$${unclaimedBalance.toFixed(4)} / $${LOOT_BOX_THRESHOLD.toFixed(4)}`;

            if (unclaimedBalance > 0 && !lootBox.classList.contains('visible')) {
                lootBox.classList.add('visible');
            } else if (unclaimedBalance <= 0) {
                 lootBox.classList.remove('visible');
            }

            if (unclaimedBalance >= LOOT_BOX_THRESHOLD) {
                claimButton.disabled = false;
                if (!lootBox.classList.contains('pulsate')) {
                    lootBox.classList.add('pulsate');
                }
            } else {
                claimButton.disabled = true;
                lootBox.classList.remove('pulsate');
            }
        }
        
        async function syncUnclaimedVideoBalance() {
            if (!currentUser) return;
            try {
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    unclaimedVideoUsdt: currentUser.unclaimedVideoUsdt,
                    totalVideoWatchSecondsToday: currentUser.totalVideoWatchSecondsToday
                });
            } catch (error) { console.error("Failed to sync unclaimed video balance:", error); }
        }

        async function claimVideoRewards() {
            const claimButton = document.getElementById('video-claim-button-box');
            if (currentUser.unclaimedVideoUsdt < LOOT_BOX_THRESHOLD) return;

            claimButton.disabled = true;
            claimButton.textContent = 'Claiming...';
            
            const amountToClaim = Math.floor(currentUser.unclaimedVideoUsdt / LOOT_BOX_THRESHOLD) * LOOT_BOX_THRESHOLD;
            if (amountToClaim <= 0) {
                claimButton.textContent = 'Claim';
                updateVideoLootBoxUI();
                return;
            }

            try {
                await grantReward({ usdt: amountToClaim }, { type: 'Video Reward', details: 'Claimed from Video Loot Box' });
                
                await updateDoc(doc(db, 'users', currentUser.id), {
                    unclaimedVideoUsdt: increment(-amountToClaim)
                });
                
                showSuccessModal("Reward Claimed!", `You claimed $${amountToClaim.toFixed(4)} from watching videos.`);
                await fetchAndUpdateCurrentUser();
                updateVideoLootBoxUI();

            } catch(error) {
                console.error("Error claiming video rewards:", error);
                alert("Failed to claim rewards. Please try again.");
            } finally {
                claimButton.textContent = 'Claim';
                updateVideoLootBoxUI();
            }
        }
        document.getElementById('video-claim-button-box').addEventListener('click', claimVideoRewards);

        function triggerCoinVFX(playerElement) {
            const lootBox = document.getElementById('video-loot-box');
            if (!lootBox || !playerElement) return;

            const playerRect = playerElement.getBoundingClientRect();
            const boxRect = lootBox.getBoundingClientRect();

            const coin = document.createElement('div');
            coin.className = 'coin-vfx';
            document.body.appendChild(coin);
            
            const startX = playerRect.left + playerRect.width / 2;
            const startY = playerRect.top + playerRect.height / 2;
            const endX = boxRect.left + boxRect.width / 2;
            const endY = boxRect.top + boxRect.height / 2;

            coin.style.left = `${startX}px`; coin.style.top = `${startY}px`;
            coin.style.setProperty('--end-x', `${endX - startX}px`);
            coin.style.setProperty('--end-y', `${endY - startY}px`);
            setTimeout(() => coin.remove(), 700);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                if (videoWatchTimer) clearInterval(videoWatchTimer);
                if (videoSyncTimer) clearInterval(videoSyncTimer);

                videoWatchTimer = setInterval(() => {
                    if (!currentUser) return;
                    
                    let earnedToday = (currentUser.totalVideoWatchSecondsToday || 0) * VIDEO_REWARD_PER_SECOND;
                    if (earnedToday >= DAILY_VIDEO_EARNING_LIMIT) {
                        clearInterval(videoWatchTimer);
                        return;
                    }
                    
                    currentUser.totalVideoWatchSecondsToday = (currentUser.totalVideoWatchSecondsToday || 0) + 1;
                    currentUser.unclaimedVideoUsdt = (currentUser.unclaimedVideoUsdt || 0) + VIDEO_REWARD_PER_SECOND;
                    
                    if (currentUser.totalVideoWatchSecondsToday % 5 === 0) {
                        triggerCoinVFX(event.target.getIframe());
                    }
                    updateVideoLootBoxUI();
                }, 1000);
                
                videoSyncTimer = setInterval(syncUnclaimedVideoBalance, 20000); // Sync less frequently

            } else {
                if (videoWatchTimer) clearInterval(videoWatchTimer);
                if (videoSyncTimer) {
                    clearInterval(videoSyncTimer);
                    syncUnclaimedVideoBalance(); // Sync on pause/stop
                }
            }
        }
        
        function hideAllFloatingElements() {
            document.getElementById('video-loot-box').classList.remove('visible', 'pulsate');
        }

        function stopAllSectionActivity() {
            if(videoWatchTimer) clearInterval(videoWatchTimer);
            if(videoSyncTimer) {
                clearInterval(videoSyncTimer);
                syncUnclaimedVideoBalance(); // Final sync before leaving section
            }
            videoWatchTimer = null; videoSyncTimer = null;
            if (currentPlayingItem?.originalContent) { try { currentPlayingItem.innerHTML = currentPlayingItem.originalContent; } catch(e) {} }
            if (player) { try { player.destroy(); } catch (e) {} player = null; }
            currentPlayingItem = null;
            hideAllFloatingElements();
        }
        
        // --- UPDATE 5: Ads Section Logic ---
        function setupAdsToEarn() {
            const container = document.getElementById('ad-task-list');
            container.innerHTML = '';
            if (!currentUser) return;

            const adSets = [
                { id: '1', title: 'View Ads (Set 1)', viewsToday: currentUser.dailyAdViews_set1 || 0 },
                { id: '2', title: 'View Ads (Set 2)', viewsToday: currentUser.dailyAdViews_set2 || 0 },
            ];

            adSets.forEach(task => {
                const viewsLeft = ADS_PER_SET - task.viewsToday;
                const isCompleted = viewsLeft <= 0;
                
                const card = document.createElement('div');
                card.className = 'ad-task-card';
                card.innerHTML = `
                    <div class="ad-task-card-info">
                        <h4>${task.title}</h4>
                        <p>Reward: <span class="task-reward-usdt">$${AD_REWARD_USDT.toFixed(4)}</span> per ad</p>
                        <p>Progress: ${task.viewsToday} / ${ADS_PER_SET} ads watched</p>
                    </div>
                    <button class="ad-task-button" data-task-id="${task.id}" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'Completed Today' : `View Ad (${viewsLeft} left)`}
                    </button>`;
                container.appendChild(card);
            });
        }
        
        document.getElementById('ad-task-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.ad-task-button');
            if (!button || button.disabled) return;
            
            const setId = button.dataset.taskId;
            button.disabled = true; button.textContent = 'Loading Ad...';
            
            let adTimer = null; let adSuccess = false; let countdown = 10;

            const startTimer = () => {
                if (adTimer) clearInterval(adTimer);
                adTimer = setInterval(async () => {
                    countdown--;
                    button.textContent = `Wait ${countdown}s`;
                    if (countdown <= 0) {
                        adSuccess = true; clearInterval(adTimer);
                        button.textContent = 'Processing...';
                        
                        try {
                            const updateField = `dailyAdViews_set${setId}`;
                            await grantReward({ usdt: AD_REWARD_USDT }, { type: 'Ad Reward', details: `Watched Ad from Set ${setId}`});
                            await updateDoc(doc(db, 'users', currentUser.id), { [updateField]: increment(1) });
                            await fetchAndUpdateCurrentUser();
                            setupAdsToEarn(); 
                        } catch (error) {
                            console.error("Error updating ad views:", error);
                            alert("Failed to update progress. Please try again.");
                            setupAdsToEarn();
                        }
                    }
                }, 1000);
            };

            try {
                window.onAdClosed = () => {
                    clearInterval(adTimer);
                    if (!adSuccess) {
                        alert('Ad closed too early. No reward given.');
                        setupAdsToEarn(); 
                    }
                };
                await showRandomAd(); 
                button.textContent = `Wait ${countdown}s`;
                startTimer();
            } catch (err) {
                console.error("Ad failed to load:", err);
                clearInterval(adTimer);
                alert('Ad failed to load or was closed. Please try again.');
                setupAdsToEarn();
            }
        });

        async function fetchAndRenderTasks(containerId, count) {
            const taskListContainer = document.getElementById(containerId);
            taskListContainer.innerHTML = '<div class="loader"></div>';
            if (!currentUser) return;
            try {
                const q = query(collection(db, 'tasks'), where("isApproved", "==", true), orderBy("createdAt", "desc"), limit(count));
                const snapshot = await getDocs(q);
                taskListContainer.innerHTML = '';
                
                let tasksRendered = 0;
                snapshot.forEach(docSnap => {
                    const task = docSnap.data();
                    if (task.creatorId === currentUser.id || currentUser.completedTasks?.includes(docSnap.id)) return;
                    const isLimitReached = (task.limit || 0) > 0 && (task.completionCount || 0) >= task.limit;
                    if (isLimitReached) return; 

                    const card = document.createElement('div');
                    card.className = 'task-card';
                    card.innerHTML = `<div class="task-card-info"><h4>${task.title}</h4><p>Reward: <span class="task-reward-usdt">$${(task.rewardUsdt || 0).toFixed(4)} USDT</span></p></div><button class="task-button" data-task-id="${docSnap.id}" data-task-url="${task.url}" data-state="start">Go</button>`;
                    taskListContainer.appendChild(card);
                    tasksRendered++;
                });

                if (tasksRendered === 0) {
                    taskListContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">No new tasks available for you right now.</p>';
                }

            } catch (error) {
                console.error("Error fetching tasks:", error);
                taskListContainer.innerHTML = '<p style="color:red; text-align:center; grid-column: 1 / -1;">Could not load tasks.</p>';
            }
        }
        
        document.getElementById('task-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.task-button');
            if (!button || button.disabled) return;
            
            const { taskId, taskUrl, state } = button.dataset;

            if (state === 'start') {
                tg.openLink(taskUrl);
                button.disabled = true; let countdown = 6;
                button.textContent = `Claim in ${countdown}s`;
                const timer = setInterval(() => {
                    countdown--; button.textContent = `Claim in ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(timer); button.disabled = false;
                        button.textContent = 'Claim Reward'; button.dataset.state = 'claim';
                    }
                }, 1000);
            } else if (state === 'claim') {
                showTaskConfirmationModal(taskId, taskUrl, button);
            }
        });

        function showTaskConfirmationModal(taskId, taskUrl, buttonElement) {
            const modal = document.getElementById('taskConfirmModalOverlay');
            const goBackButton = document.getElementById('taskConfirmGoBackBtn');
            const submitButton = document.getElementById('taskConfirmSubmitBtn');
            
            goBackButton.onclick = () => { tg.openLink(taskUrl); modal.classList.remove('show'); };
            
            submitButton.onclick = async () => {
                modal.classList.remove('show');
                await processTaskClaim(taskId, buttonElement);
            };
            modal.classList.add('show');
        }

        async function processTaskClaim(taskId, button) {
            const taskCard = button.closest('.task-card');
            button.disabled = true; button.textContent = 'Verifying...';
            
            try {
                const taskDocSnap = await getDoc(doc(db, 'tasks', taskId));
                if (!taskDocSnap.exists()) throw new Error("Task not found.");
                const taskData = taskDocSnap.data();
                const rewardAmount = taskData.rewardUsdt || 0;
                if (rewardAmount <= 0) throw new Error("Task has no reward.");

                await runTransaction(db, async (t) => {
                    const userRef = doc(db, 'users', currentUser.id);
                    const taskRef = doc(db, 'tasks', taskId);
                    const userDoc = await t.get(userRef);
                    if (userDoc.data().completedTasks?.includes(taskId)) throw "ALREADY_COMPLETED";
                    t.update(userRef, { completedTasks: arrayUnion(taskId) });
                    t.update(taskRef, { completionCount: increment(1) });
                });
                
                await grantReward({ usdt: rewardAmount }, { type: 'Task Reward', details: 'Completed user-created task' });
                showSuccessModal("Task Verified!", `$${rewardAmount.toFixed(4)} has been added to your balance.`);
                
                if (taskCard) taskCard.remove();
                await fetchAndUpdateCurrentUser();

            } catch (error) {
                alert('Failed to claim reward. ' + (error.message || error));
                button.disabled = false; button.textContent = 'Claim Reward';
            }
        }
        
        function renderDailyTasks() {
            const container = document.getElementById('daily-tasks-grid');
            if (!currentUser) { container.innerHTML = ''; return; }
            
            const claimedDaily = currentUser.claimedDailyRewards || [];
            const tasks = [
                { id: 'tg_1', type: 'visit', title: 'Visit Official Channel', reward: 0.001, url: 'https://t.me/tech_and_touch', completed: currentUser.dailyTelegramVisit1Completed, visitTime: 5 },
                { id: 'tg_2', type: 'visit', title: 'Visit Payment Channel', reward: 0.001, url: 'https://t.me/newtube12', completed: currentUser.dailyTelegramVisit2Completed, visitTime: 5 },
                { id: 'web_1', type: 'visit', title: 'Visit Website 1', reward: 0.003, url: 'https://suggestbingo.com/qr4ys636p?key=0098a30fe6a07c76104029fc8045e1bd', completed: currentUser.dailyBrowseVisit1Completed, visitTime: 15 },
                { id: 'web_2', type: 'visit', title: 'Visit Website 2', reward: 0.003, url: 'https://suggestbingo.com/qr4ys636p?key=0098a30fe6a07c76104029fc8045e1bd', completed: currentUser.dailyBrowseVisit2Completed, visitTime: 15 },
            ];

            container.innerHTML = tasks.map(task => {
                let buttonHtml = '';
                if (claimedDaily.includes(task.id)) {
                    buttonHtml = `<button class="daily-task-button" disabled>Claimed</button>`;
                } else if (task.completed) {
                     buttonHtml = `<button class="daily-task-button" data-task-id="${task.id}" data-reward="${task.reward}" data-action="claim-visit">Claim</button>`;
                } else {
                    buttonHtml = `<button class="daily-task-button" data-task-id="${task.id}" data-url="${task.url}" data-time="${task.visitTime}" data-action="visit">Go</button>`;
                }
                return `
                    <div class="task-card">
                        <div class="task-card-info">
                            <h4>${task.title}</h4>
                            <p>Reward: <span class="task-reward-usdt">$${task.reward.toFixed(4)} USDT</span></p>
                        </div>
                        ${buttonHtml}
                    </div>`;
            }).join('');
        }

        document.getElementById('daily-tasks-grid').addEventListener('click', async (e) => {
            const button = e.target.closest('.daily-task-button');
            if (!button || button.disabled) return;

            const { taskId, reward, action, url, time } = button.dataset;
            const userRef = doc(db, 'users', currentUser.id);

            if (action === 'claim-visit') {
                button.disabled = true; button.textContent = "Claiming...";
                try {
                    await grantReward({ usdt: parseFloat(reward) }, { type: 'Daily Reward', details: `Claimed for daily task ${taskId}` });
                    await updateDoc(userRef, { claimedDailyRewards: arrayUnion(taskId) });
                    showSuccessModal("Reward Claimed!", `+$${reward} added to your balance.`);
                    renderDailyTasks();
                } catch (err) { alert('Failed to claim reward.'); button.disabled = false; button.textContent = "Claim"; }
            } else if (action === 'visit') {
                tg.openLink(url);
                button.disabled = true; let countdown = parseInt(time, 10);
                button.textContent = `Wait ${countdown}s`;
                const timer = setInterval(async () => {
                    countdown--; button.textContent = `Wait ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(timer); button.textContent = `Processing...`;
                        const updateField = {
                            'tg_1': 'dailyTelegramVisit1Completed', 'tg_2': 'dailyTelegramVisit2Completed',
                            'web_1': 'dailyBrowseVisit1Completed', 'web_2': 'dailyBrowseVisit2Completed'
                        }[taskId];
                        if (updateField) {
                            await updateDoc(userRef, { [updateField]: true });
                            await fetchAndUpdateCurrentUser(); renderDailyTasks();
                        }
                    }
                }, 1000);
            }
        });

        function renderTaskPackages() {
            const grid = document.getElementById('ad-package-grid');
            grid.innerHTML = adPackages.map(pkg => `
                <div class="ad-package-card" data-package-id="${pkg.id}">
                    <h4>${pkg.tasks} Tasks</h4>
                    <p>${pkg.price.toFixed(2)} USDT</p>
                </div>`).join('');
        }
        
        document.getElementById('ad-package-grid').addEventListener('click', (e) => {
            const card = e.target.closest('.ad-package-card');
            if (!card) return;
            document.querySelectorAll('#ad-package-grid .ad-package-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedAdPackage = adPackages.find(p => p.id === parseInt(card.dataset.packageId, 10));
        });

        async function renderMyAds() {
            const container = document.getElementById('my-ads-list');
            container.innerHTML = '<div class="loader"></div>';
            if (!currentUser) return;
            try {
                const q = query(collection(db, 'tasks'), where("creatorId", "==", currentUser.id), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { container.innerHTML = '<p style="text-align:center;">You have not created any task advertisements yet.</p>'; return; }
                container.innerHTML = snapshot.docs.map(docSnap => {
                    const ad = docSnap.data();
                    const isCompleted = (ad.completionCount || 0) >= (ad.limit || 0);
                    return `
                    <div class="user-ad-item task-card">
                        <div>
                           <h4>${ad.title}</h4>
                           <p class="info-text" style="word-break: break-all;">URL: ${ad.url}</p>
                           <p class="progress-text">Progress: ${(ad.completionCount || 0)} / ${ad.limit}</p>
                        </div>
                        <p class="status-text ${isCompleted ? 'completed' : 'active'}">${isCompleted ? 'Completed ✅' : 'Active'}</p>
                    </div>`;
                }).join('');
            } catch (error) {
                console.error("Error fetching my ads:", error);
                container.innerHTML = '<p style="text-align:center; color: red;">Could not load your ads.</p>';
            }
        }

        document.getElementById('create-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (!selectedAdPackage) { alert('Please select a task package.'); return; }
            const title = document.getElementById('task-title-input').value.trim();
            const url = document.getElementById('task-url-input').value.trim();
            if (!title || !url) { alert('Please provide both a title and a URL for your task.'); return; }
            if ((currentUser.usdtBalance || 0) < selectedAdPackage.price) { alert('Insufficient USDT balance to purchase this package.'); return; }
            
            submitBtn.disabled = true; submitBtn.textContent = 'Processing...';
            try {
                await runTransaction(db, async (t) => {
                    const userRef = doc(db, 'users', currentUser.id);
                    t.update(userRef, { usdtBalance: increment(-selectedAdPackage.price) });
                    const newTaskData = { title, url, rewardUsdt: USER_CREATED_TASK_REWARD_USDT, limit: selectedAdPackage.tasks, completionCount: 0, creatorId: currentUser.id, isApproved: true, createdAt: serverTimestamp() };
                    t.set(doc(collection(db, 'tasks')), newTaskData);
                });
                showSuccessModal("Task Created!", "Your new task is now live for other users to complete.");
                e.target.reset();
                document.querySelectorAll('#ad-package-grid .ad-package-card.selected').forEach(c => c.classList.remove('selected'));
                selectedAdPackage = null;
                document.getElementById('createTaskModalOverlay').classList.remove('show');
                await fetchAndUpdateCurrentUser();
                await renderMyAds();
            } catch (error) {
                alert(`Failed to create task: ${error.message}`);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Create Task';
            }
        });

        function showSuccessModal(title, message) {
            document.getElementById('successModalTitle').textContent = title;
            document.getElementById('successModalMessage').innerHTML = message;
            document.getElementById('successModalOverlay').classList.add('show');
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => { document.getElementById('successModalOverlay').classList.remove('show'); }, 4000);
        }
        
        // --- UPDATE 7: New Withdrawal Logic ---
        function setupWithdrawalUI() {
            if (!currentUser) return;
            const balance = currentUser.usdtBalance || 0;
            document.getElementById('withdrawUsdtBalance').textContent = `$${balance.toFixed(4)}`;
            const methodSelect = document.getElementById('withdrawalMethod');
            const amountInput = document.getElementById('withdrawalAmount');

            const updateSummary = () => {
                const method = methodSelect.value;
                const amount = parseFloat(amountInput.value);
                const config = WITHDRAWAL_CONFIG[method];
                const summaryBox = document.getElementById('withdraw-summary');

                if (!config) { summaryBox.style.display = 'none'; return; }
                
                document.getElementById('summary-min').textContent = `$${config.min.toFixed(2)}`;
                document.getElementById('summary-fee').textContent = `$${config.fee.toFixed(2)}`;
                
                if (!isNaN(amount) && amount > 0) {
                    const receiveAmount = amount - config.fee;
                    document.getElementById('summary-receive').textContent = `$${receiveAmount > 0 ? receiveAmount.toFixed(4) : '0.0000'}`;
                } else {
                    document.getElementById('summary-receive').textContent = '$0.0000';
                }
                summaryBox.style.display = 'block';
            };
            
            methodSelect.addEventListener('change', updateSummary);
            amountInput.addEventListener('input', updateSummary);
            updateSummary(); // Initial call
        }

        document.getElementById('submitWithdrawalBtn').addEventListener('click', () => {
            if(isSubmittingWithdrawal) return;

            const method = document.getElementById('withdrawalMethod').value;
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const details = document.getElementById('accountDetails').value.trim();
            const config = WITHDRAWAL_CONFIG[method];

            if (!details) { alert('Please enter your account details.'); return; }
            if (isNaN(amount) || amount <= 0) { alert('Please enter a valid amount.'); return; }
            if (amount < config.min) { alert(`Minimum withdrawal for ${method} is $${config.min.toFixed(2)}.`); return; }
            if ((currentUser.usdtBalance || 0) < amount) { alert('Insufficient balance.'); return; }

            showWithdrawalConfirmationModal(amount, method, details, config.fee);
        });

        function showWithdrawalConfirmationModal(amount, method, details, fee) {
            const modal = document.getElementById('withdrawConfirmModalOverlay');
            document.getElementById('withdrawConfirmText').textContent = `Withdraw $${amount.toFixed(4)} to ${method} (${details})? A fee of $${fee.toFixed(2)} will be applied.`;
            
            const cancelBtn = document.getElementById('withdrawConfirmCancelBtn');
            const confirmBtn = document.getElementById('withdrawConfirmSubmitBtn');
            const close = () => modal.classList.remove('show');

            const handleConfirm = async () => { close(); await processUsdtWithdrawal(amount, method, details, fee); };
            cancelBtn.onclick = close; confirmBtn.onclick = handleConfirm;
            modal.classList.add('show');
        }

        async function processUsdtWithdrawal(amount, method, details, fee) {
            isSubmittingWithdrawal = true;
            try {
                await runTransaction(db, async (t) => {
                    const userRef = doc(db, 'users', currentUser.id);
                    const userDoc = await t.get(userRef);
                    if ((userDoc.data().usdtBalance || 0) < amount) throw new Error(`Insufficient balance.`);
                    
                    const requestData = { 
                        userId: currentUser.id, telegramUsername: currentUser.telegramUsername, 
                        method, details, status: 'pending', createdAt: serverTimestamp(), 
                        withdrawType: 'usdt', fee, totalDeducted: amount, usdAmount: amount - fee 
                    };
                    t.set(doc(collection(db, 'withdrawals')), requestData);
                    t.update(userRef, { usdtBalance: increment(-amount) });
                });
                await fetchAndUpdateCurrentUser();
                document.getElementById('withdrawalForm').reset();
                showSuccessModal("Request Sent!", `Your withdrawal request is pending. Check status in the History tab.`);
            } catch (error) { 
                alert(`Error: ${error.message}`); 
            } finally { 
                isSubmittingWithdrawal = false;
                setupWithdrawalUI();
            }
        }
        
        async function showCombinedHistory() {
            const historyContainer = document.getElementById('combined-history-list');
            const modal = document.getElementById('historyModalOverlay');
            modal.classList.add('show');
            historyContainer.innerHTML = '<div class="loader"></div>';
            try {
                const withdrawalsQuery = query(collection(db, "withdrawals"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"), limit(25));
                const transactionsQuery = query(collection(db, "transactions"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"), limit(25));
                
                const [withdrawalsSnap, transactionsSnap] = await Promise.all([ getDocs(withdrawalsQuery), getDocs(transactionsQuery) ]);
                let combinedList = [];

                withdrawalsSnap.forEach(doc => combinedList.push({ ...doc.data(), type: 'Withdrawal', timestamp: doc.data().createdAt }));
                transactionsSnap.forEach(doc => combinedList.push({ ...doc.data(), timestamp: doc.data().createdAt }));
                combinedList.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                if (combinedList.length === 0) { historyContainer.innerHTML = '<p style="text-align:center;">No history found.</p>'; return; }
                
                let lastDate = null;
                historyContainer.innerHTML = combinedList.map(data => {
                    if (!data.timestamp) return '';
                    const date = data.timestamp.toDate();
                    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    
                    let dateHeaderHtml = '';
                    if (formattedDate !== lastDate) {
                        dateHeaderHtml = `<div class="history-date-header">${formattedDate}</div>`;
                        lastDate = formattedDate;
                    }
                    
                    let title = data.type; let amountStr = ''; let amountClass = '';
                    let status = data.status || 'Completed'; let statusClass = `status-${status.toLowerCase()}`;
                    
                    if (title === 'Withdrawal') {
                        amountStr = `- $${(data.totalDeducted || 0).toFixed(4)} USDT`; amountClass = 'amount-negative';
                    } else if (data.usdAmount) {
                        amountStr = `+ $${data.usdAmount.toFixed(4)} USDT`; amountClass = 'amount-positive';
                    }

                    return `${dateHeaderHtml}
                        <div class="history-item">
                            <div class="history-item-left"><strong>${title}</strong><small>${data.details || formattedTime}</small></div>
                            <div class="history-item-right"><strong class="${amountClass}">${amountStr}</strong><small class="${statusClass}">${status}</small></div>
                        </div>`;
                }).join('');

            } catch (error) {
                console.error("Error fetching combined history:", error);
                historyContainer.innerHTML = '<p style="color:red;text-align:center;">Error loading history.</p>';
            }
        }
        
        const showMonetagAd = () => new Promise((res, rej) => typeof show_9442539 === 'function' ? show_9442539().then(res).catch(rej) : rej('Monetag SDK missing'));
        const showGigaPubAd = () => new Promise((res, rej) => typeof window.showGiga === 'function' ? window.showGiga("main").then(res).catch(rej) : rej('GigaPub SDK missing'));
        const showAdextraAd = () => new Promise((res, rej) => typeof p_adextra === 'function' ? p_adextra({ onSuccess: res, onError: (e) => rej(new Error("Adextra ad failed: " + e)) }) : rej('Adextra SDK missing'));

        async function showRandomAd() {
            const adProviders = [showMonetagAd, showGigaPubAd, showAdextraAd];
            const randomAdProvider = adProviders[Math.floor(Math.random() * adProviders.length)];
            try { await randomAdProvider(); } 
            catch(err) { console.warn("An ad provider failed, trying another one...", err);
                const otherProviders = adProviders.filter(p => p !== randomAdProvider);
                if (otherProviders.length > 0) {
                    const fallbackProvider = otherProviders[Math.floor(Math.random() * otherProviders.length)];
                    try { await fallbackProvider(); } catch(fallbackErr) { console.error("Fallback ad provider also failed:", fallbackErr); throw fallbackErr; }
                } else { throw err; }
            }
        }
        
        document.getElementById('history-btn').addEventListener('click', showCombinedHistory);
        document.getElementById('closeHistoryBtn').addEventListener('click', () => document.getElementById('historyModalOverlay').classList.remove('show'));
        document.getElementById('show-create-task-btn').addEventListener('click', () => document.getElementById('createTaskModalOverlay').classList.add('show'));
        document.getElementById('closeTaskModalBtn').addEventListener('click', () => document.getElementById('createTaskModalOverlay').classList.remove('show'));

        document.querySelectorAll('.bottom-nav-item').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const targetId = link.dataset.tabTarget;
                if (!currentUser || document.querySelector(targetId)?.classList.contains('active')) return;
                
                stopAllSectionActivity();
                document.querySelectorAll('.bottom-nav-item.active, .content-section.active').forEach(el => el.classList.remove('active'));
                
                link.classList.add('active');
                document.querySelector(targetId).classList.add('active');

                switch(targetId) {
                    case '#home-content': renderDailyTasks(); break;
                    case '#ads-content': setupAdsToEarn(); break;
                    case '#video-content': await fetchContent(); updateVideoLootBoxUI(); break;
                    case '#task-content': 
                        renderTaskPackages();
                        await renderMyAds(); 
                        await fetchAndRenderTasks('task-list', 50);
                        break;
                    case '#withdraw-content': setupWithdrawalUI(); break;
                    case '#support-content': /* No action needed */ break;
                }
            });
        });
        
        function setupUserIdDisplay(userId) {
            const userIdContainer = document.getElementById('header-user-id');
            userIdContainer.querySelector('span').textContent = `ID: ${userId}`;
            userIdContainer.addEventListener('click', () => {
                navigator.clipboard.writeText(userId).then(() => {
                    if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    showSuccessModal("Copied!", `User ID ${userId} copied to clipboard.`);
                });
            });
        }
        
        async function showDailyNoticePopup() {
            const lastShown = currentUser.lastNoticeShown?.toDate();
            const now = new Date();
            if (lastShown && (now.getTime() - lastShown.getTime()) < 24 * 60 * 60 * 1000) return;
            
            const overlay = document.getElementById('noticeModalOverlay');
            overlay.classList.add('show');
            document.getElementById('noticeConfirmBtn').addEventListener('click', async () => {
                overlay.classList.remove('show');
                await updateDoc(doc(db, 'users', currentUser.id), { lastNoticeShown: serverTimestamp() });
            }, { once: true });
        }

        // --- UPDATE 1: Profile Popover Logic ---
        function updateProfilePopover() {
            if (!currentUser) return;
            document.getElementById('popover-total-referrals').textContent = currentUser.referralCount || 0;
            document.getElementById('popover-total-usdt-earned').textContent = `$${(currentUser.lifetimeUsdtEarned || 0).toFixed(4)}`;
            document.getElementById('popover-total-tasks-done').textContent = currentUser.completedTasks?.length || 0;
        }

        const profileBtn = document.getElementById('profile-info-btn');
        const popover = document.getElementById('profile-popover');
        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            updateProfilePopover();
            popover.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (!popover.contains(e.target) && !profileBtn.contains(e.target)) {
                popover.classList.remove('show');
            }
        });
        document.getElementById('popoverCopyRefLinkBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const copyButton = e.target;
            navigator.clipboard.writeText(copyButton.previousElementSibling.value).then(() => {
                copyButton.textContent = 'Copied!';
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
            });
        });

        async function main() {
            try {
                if (!tg.initDataUnsafe?.user) { document.body.innerHTML = `<div class="card"><h3>Error</h3><p>This app can only be launched from Telegram.</p></div>`; return; }
                tg.ready(); tg.expand();
                
                const initStatus = await initializeUser(tg.initDataUnsafe.user, tg.initDataUnsafe.start_param);
                if (!initStatus) return;

                setupUserIdDisplay(currentUser.id);
                showDailyNoticePopup();
                renderDailyTasks();
            } catch (error) {
                console.error("Initialization failed:", error);
                document.body.innerHTML = `<div class="card"><h3>Application Error</h3><p>Could not initialize. Please restart.</p><p style="font-size: 0.8em; color: #888;">Error: ${error.message}</p></div>`;
            }
        }
        main();
    </script>

</body>
</html>